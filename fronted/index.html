<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewFEM - Focused Emboli Monitor</title>
    <style>
        /* --- VS Code Theme Variables --- */
        :root {
            --bg-color: #1e1e1e;
            --sidebar-bg: #252526;
            --activity-bar-bg: #333333;
            --text-color: #cccccc;
            --text-highlight: #ffffff;
            --accent-color: #007acc;
            --accent-hover: #0062a3;
            --border-color: #3e3e42;
            --input-bg: #3c3c3c;
            --button-bg: #0e639c;
            --button-hover: #1177bb;
            --success-color: #4ec9b0;
            --warning-color: #dcdcaa;
            --error-color: #f48771;
            --grid-color: #404040;
            --baseline-color: #dcdcaa;
            --chart-line-color: #4ec9b0;
            --panel-header-bg: #303031;
            --status-bar-bg: #007acc;
        }

        /* --- Global Reset & Layout --- */
        * { box-sizing: border-box; margin: 0; padding: 0; user-select: none; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
            font-size: 13px;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 300px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .panel {
            border-bottom: 1px solid var(--border-color);
        }

        .panel-header {
            background-color: var(--panel-header-bg);
            padding: 8px 12px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        
        .panel-content {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* --- UI Components --- */
        .status-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
        }

        .status-value {
            color: var(--text-highlight);
            font-family: 'Consolas', 'Courier New', monospace;
        }

        .indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .indicator.connected { background-color: var(--success-color); box-shadow: 0 0 5px var(--success-color); }
        .indicator.disconnected { background-color: var(--error-color); }
        .indicator.connecting { background-color: var(--warning-color); animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .control-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        button {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            border-radius: 2px;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) { background-color: var(--button-hover); }
        button:disabled { background-color: #3a3a3a; color: #888; cursor: not-allowed; }
        button.danger { background-color: #a1260d; }
        button.danger:hover { background-color: #c93312; }

        .toggle-switch {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        .toggle-switch input { display: none; }
        .slider {
            width: 30px;
            height: 16px;
            background-color: #3a3a3a;
            border-radius: 10px;
            position: relative;
            margin-right: 8px;
            transition: .2s;
        }
        .slider:before {
            content: "";
            position: absolute;
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            border-radius: 50%;
            transition: .2s;
        }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(14px); }

        .range-slider-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        input[type=range] {
            width: 100%;
            background: transparent;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            margin-top: -5px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #3a3a3a;
            border-radius: 2px;
        }

        #roi-canvas {
            background-color: #000;
            border: 1px solid var(--border-color);
            width: 200px;
            height: 150px;
            margin: 0 auto;
            image-rendering: pixelated;
        }

        /* --- Main Content --- */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #1e1e1e;
            position: relative;
        }

        .chart-toolbar {
            height: 35px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 16px;
            background-color: var(--bg-color);
        }

        .chart-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        .status-bar {
            height: 22px;
            background-color: var(--status-bar-bg);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 11px;
            justify-content: space-between;
        }

        /* Tooltip */
        #tooltip {
            position: absolute;
            background: rgba(37, 37, 38, 0.9);
            border: 1px solid var(--accent-color);
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 11px;
            pointer-events: none;
            display: none;
            z-index: 100;
        }

        /* Signal indicators */
        .signal-indicator {
            padding: 2px 6px;
            border-radius: 2px;
            font-weight: bold;
        }
        .signal-green { color: var(--success-color); background: rgba(78, 201, 176, 0.1); }
        .signal-red { color: var(--error-color); background: rgba(244, 135, 113, 0.1); }
        .signal-none { color: #666; }

        /* ROI è¾“å…¥æ¡†æ ·å¼ */
        .roi-input {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'Consolas', 'Courier New', monospace;
            text-align: right;
        }
        .roi-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 1px var(--accent-color);
        }
        .roi-input:invalid {
            border-color: var(--error-color);
        }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <!-- 3.1 ç³»ç»ŸçŠ¶æ€é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">ç³»ç»ŸçŠ¶æ€</div>
            <div class="panel-content">
                <div class="status-row">
                    <span>è¿æ¥çŠ¶æ€</span>
                    <div>
                        <span id="connection-indicator" class="indicator disconnected"></span>
                        <span id="connection-text">Disconnected</span>
                    </div>
                </div>
                <div class="status-row">
                    <span>å¸§æ•°è®¡æ•°</span>
                    <span id="frame-count" class="status-value">0</span>
                </div>
                <div class="status-row">
                    <span>å½“å‰å€¼</span>
                    <span id="current-value" class="status-value">0.00</span>
                </div>
                <div class="status-row">
                    <span>åŸºçº¿å€¼</span>
                    <span id="baseline-value" class="status-value">0.00</span>
                </div>
                <div class="status-row">
                    <span>æ³¢å³°ä¿¡å·</span>
                    <span id="peak-signal" class="status-value signal-none">NULL</span>
                </div>
                 <div class="status-row">
                    <span>ç¼“å†²åŒº</span>
                    <span id="buffer-size" class="status-value">0</span>
                </div>
                <div class="status-row">
                    <span>FPS</span>
                    <span id="update-rate" class="status-value">0 Hz</span>
                </div>
            </div>
        </div>

        <!-- 3.2 æ˜¾ç¤ºæ§åˆ¶é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">æ˜¾ç¤ºæ§åˆ¶</div>
            <div class="panel-content">
                <label class="toggle-switch">
                    <input type="checkbox" id="show-grid" checked>
                    <div class="slider"></div>
                    <span>æ˜¾ç¤ºç½‘æ ¼</span>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="show-baseline" checked>
                    <div class="slider"></div>
                    <span>æ˜¾ç¤ºåŸºçº¿</span>
                </label>
                <label class="toggle-switch">
                    <input type="checkbox" id="show-points" checked>
                    <div class="slider"></div>
                    <span>æ˜¾ç¤ºæ•°æ®ç‚¹</span>
                </label>
                
                <div class="range-slider-container">
                    <div class="status-row">
                        <span>Yè½´ç¼©æ”¾</span>
                        <span id="zoom-value" class="status-value">1.0x</span>
                    </div>
                    <input type="range" id="zoom-slider" min="0.5" max="3.0" step="0.1" value="1.0">
                </div>
            </div>
        </div>

        <!-- 3.3 ROI å›¾åƒæ˜¾ç¤º -->
        <div class="panel">
            <div class="panel-header">ROI ç›‘æ§</div>
            <div class="panel-content" style="align-items: center;">
                <canvas id="roi-canvas" width="200" height="150"></canvas>
                <div class="status-row" style="width: 100%">
                    <span>ROI å¹³å‡ç°åº¦:</span>
                    <span id="roi-gray-value" class="status-value">0.0</span>
                </div>
            </div>
        </div>

        <!-- 3.4 ROI è®¾ç½®é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">ROI è®¾ç½®</div>
            <div class="panel-content">
                <!-- ROIé…ç½®çŠ¶æ€æŒ‡ç¤º -->
                <div class="status-row">
                    <span>é…ç½®çŠ¶æ€:</span>
                    <div>
                        <span id="roi-status-indicator" class="indicator disconnected"></span>
                        <span id="roi-status-text">æœªé…ç½®</span>
                    </div>
                </div>
                <div class="status-row">
                    <span>x1 åæ ‡:</span>
                    <input type="number" id="roi-x1" class="roi-input" value="0" min="0" style="width: 80px;">
                </div>
                <div class="status-row">
                    <span>y1 åæ ‡:</span>
                    <input type="number" id="roi-y1" class="roi-input" value="0" min="0" style="width: 80px;">
                </div>
                <div class="status-row">
                    <span>x2 åæ ‡:</span>
                    <input type="number" id="roi-x2" class="roi-input" value="200" min="0" style="width: 80px;">
                </div>
                <div class="status-row">
                    <span>y2 åæ ‡:</span>
                    <input type="number" id="roi-y2" class="roi-input" value="150" min="0" style="width: 80px;">
                </div>
                <hr style="border: 1px solid var(--border-color); margin: 10px 0;">
                <div class="status-row">
                    <span>ä¸­å¿ƒç‚¹:</span>
                    <span id="roi-center" class="status-value">(100, 75)</span>
                </div>
                <div class="status-row">
                    <span>å®½åº¦:</span>
                    <span id="roi-width" class="status-value">200 px</span>
                </div>
                <div class="status-row">
                    <span>é«˜åº¦:</span>
                    <span id="roi-height" class="status-value">150 px</span>
                </div>
                <div class="status-row">
                    <span>å¸§ç‡è®¾ç½®:</span>
                    <input type="number" id="roi-frame-rate" class="roi-input" value="2" min="1" max="60" style="width: 80px;">
                    <span class="status-value" id="roi-fps-display">2 FPS</span>
                </div>
                <div class="control-group" style="margin-top: 10px;">
                    <button id="apply-roi-btn" style="width: 100%; height: 30px; font-size: 12px;">åº”ç”¨é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- 3.6 æ³¢å³°æ£€æµ‹é…ç½®é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">æ³¢å³°æ£€æµ‹è®¾ç½®</div>
            <div class="panel-content">
                <!-- ç»å¯¹é˜ˆå€¼ -->
                <div class="status-row">
                    <span>ç»å¯¹é˜ˆå€¼:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="peak-threshold" class="roi-input" value="105" min="50" max="255" step="0.1" style="width: 80px;">
                        <span class="status-value">ç°åº¦å€¼ â‰¥ é˜ˆå€¼è§¦å‘æ³¢å³°</span>
                    </div>
                </div>

                <!-- è¾¹ç•Œæ‰©å±•å¸§æ•° -->
                <div class="status-row">
                    <span>è¾¹ç•Œæ‰©å±•:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="peak-margin-frames" class="roi-input" value="5" min="1" max="20" style="width: 80px;">
                        <span class="status-value">æ³¢å³°åŒºåŸŸå‰åæ‰©å±•å¸§æ•°</span>
                    </div>
                </div>

                <!-- é¢œè‰²åˆ†ç±»é˜ˆå€¼ -->
                <div class="status-row">
                    <span>åˆ†ç±»é˜ˆå€¼:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="peak-difference-threshold" class="roi-input" value="2.1" min="0.1" max="10" step="0.1" style="width: 80px;">
                        <span class="status-value">
                            <span style="color: #4ec9b0;">ğŸŸ¢</span> å·®å€¼>é˜ˆå€¼
                            <span style="color: #f44747;">ğŸ”´</span> å·®å€¼â‰¤é˜ˆå€¼
                        </span>
                    </div>
                </div>

                <!-- æœ€å°åŒºåŸŸé•¿åº¦ -->
                <div class="status-row">
                    <span>æœ€å°åŒºåŸŸ:</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="peak-min-region-length" class="roi-input" value="3" min="1" max="20" style="width: 80px;">
                        <span class="status-value">æœ€å°æ³¢å³°åŒºåŸŸé•¿åº¦ï¼ˆå¸§ï¼‰</span>
                    </div>
                </div>

                <hr style="border: 1px solid var(--border-color); margin: 10px 0;">

                <!-- æ³¢å³°æ£€æµ‹çŠ¶æ€ -->
                <div class="status-row">
                    <span>æ£€æµ‹çŠ¶æ€:</span>
                    <div>
                        <span id="peak-status-indicator" class="indicator disconnected"></span>
                        <span id="peak-status-text">æœªæ¿€æ´»</span>
                    </div>
                </div>

                <div class="status-row">
                    <span>å½“å‰é¢œè‰²:</span>
                    <div id="current-peak-color" style="display: flex; align-items: center; gap: 5px;">
                        <span class="status-value">-</span>
                    </div>
                </div>

                <div class="control-group" style="margin-top: 10px;">
                    <button id="apply-peak-config-btn" style="width: 100%; height: 30px; font-size: 12px;">åº”ç”¨æ³¢å³°é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- 3.7 æ£€æµ‹æ§åˆ¶é¢æ¿ -->
        <div class="panel">
            <div class="panel-header">æ§åˆ¶å°</div>
            <div class="panel-content">
                <div class="status-row">
                    <span>çŠ¶æ€:</span>
                    <span id="detection-state" style="color:var(--accent-color); font-weight:bold;">IDLE</span>
                </div>
                <div class="control-group">
                    <button id="start-btn">å¼€å§‹æ£€æµ‹</button>
                    <button id="stop-btn" class="danger" disabled>åœæ­¢</button>
                    <button id="pause-btn" disabled>æš‚åœ</button>
                    <button id="resume-btn" disabled>æ¢å¤</button>
                </div>
                <button id="refresh-status-btn" style="width: 100%; margin-top: 5px;">åˆ·æ–°ç³»ç»ŸçŠ¶æ€</button>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="chart-toolbar">
            <span style="font-weight: 600; font-size: 12px;">å®æ—¶ç°åº¦æ³¢å½¢å›¾ (Real-time Waveform)</span>
        </div>
        
        <div class="chart-container" id="chart-container">
            <canvas id="waveform-chart"></canvas>
            <div id="tooltip"></div>
        </div>

        <div class="status-bar">
            <span id="chart-status">Ready</span>
            <span id="last-update">Last Update: --:--:--</span>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        /**
         * 1. å…¨å±€çŠ¶æ€ç®¡ç† (appState)
         * å¯¹åº”éœ€æ±‚ 4.1
         */
        const appState = {
            connected: false,
            serverUrl: 'http://localhost:8421', // å®é™…ç¯å¢ƒåœ°å€
            chartData: [],         // æ ¼å¼: {t: number, value: number}[]
            roiData: null,
            frameCount: 0,
            currentValue: 0,
            peakSignal: null,      // 1 (Green), 0 (Red), null
            baseline: 120,
            updateRate: 20,
            detectionState: 'IDLE', // IDLE, RUNNING, PAUSED, STOPPED
            chartState: {
                showGrid: true,
                showBaseline: true,
                showPoints: true,
                zoom: 1.0,
                offsetY: 0
            },
            // ROIé…ç½®çŠ¶æ€
            roiConfig: {
                x1: 0,
                y1: 0,
                x2: 200,
                y2: 150,
                center_x: 100,
                center_y: 75,
                width: 200,
                height: 150
            },
            roiConfigured: false,  // ROIæ˜¯å¦å·²ç”±ç”¨æˆ·é…ç½®
            // ROIæ›´æ–°é¢‘ç‡æ§åˆ¶
            roiUpdateInterval: 500,  // ROIæ›´æ–°é—´éš”ï¼ˆæ¯«ç§’ï¼‰
            lastRoiUpdate: 0,        // ä¸Šæ¬¡ROIæ›´æ–°æ—¶é—´
            roiFrameRate: 2,         // ROIå¸§ç‡ï¼ˆFPSï¼‰
            // æ³¢å³°æ£€æµ‹é…ç½®
            peakConfig: {
                threshold: 105.0,
                margin_frames: 5,
                difference_threshold: 2.1,
                min_region_length: 3
            },
            // å†…éƒ¨ä½¿ç”¨çš„é…ç½®
            maxDataPoints: 100,
            pollingIntervals: {
                realtime: null,
                status: null
            },
            mockMode: false // ä½¿ç”¨çœŸå®APIæ¥å£
        };

        /**
         * 2. Mock Server (æ¨¡æ‹Ÿåç«¯è¡Œä¸º)
         * ç”¨äºåœ¨æ— åç«¯ç¯å¢ƒä¸‹å±•ç¤ºåŠŸèƒ½
         */
        const MockServer = {
            t: 0,
            baseValue: 120,
            running: false,
            
            // ç”Ÿæˆæ¨¡æ‹Ÿå®æ—¶æ•°æ®
            getRealtimeData: function() {
                if (!this.running && appState.detectionState !== 'PAUSED') {
                    // å¦‚æœåœæ­¢ï¼Œåªè¿”å›ç©ºæˆ–é™æ­¢æ•°æ®
                     return {
                        type: "realtime_data",
                        timestamp: new Date().toISOString(),
                        frame_count: appState.frameCount,
                        series: [], 
                        peak_signal: null,
                        baseline: this.baseValue,
                        roi_data: null
                    };
                }

                // ç”Ÿæˆæ­£å¼¦æ³¢ + éšæœºå™ªå£°
                const points = [];
                const now = Date.now();
                
                // æ¨¡æ‹Ÿä¸€å¸§å†…çš„å‡ ä¸ªé‡‡æ ·ç‚¹
                for(let i=0; i<3; i++) {
                    this.t += 0.05;
                    let val = this.baseValue + Math.sin(this.t) * 10 + (Math.random() - 0.5) * 5;
                    
                    // å¶å°”ç”Ÿæˆæ³¢å³° (Peak)
                    let peak = null;
                    if (Math.random() > 0.98) {
                        val += 40; // çªå¢
                        peak = 1;
                    }

                    points.push({ t: this.t, value: val });
                }

                // ç”Ÿæˆæ¨¡æ‹Ÿ ROI (å™ªç‚¹å›¾)
                const roiPixels = new Uint8ClampedArray(200 * 150 * 4);
                for (let i = 0; i < roiPixels.length; i += 4) {
                    const gray = Math.random() * 255;
                    roiPixels[i] = gray;     // R
                    roiPixels[i + 1] = gray; // G
                    roiPixels[i + 2] = gray; // B
                    roiPixels[i + 3] = 255;  // Alpha
                }
                
                return {
                    type: "realtime_data",
                    timestamp: new Date().toISOString(),
                    frame_count: appState.frameCount + 1,
                    series: points,
                    peak_signal: Math.random() > 0.98 ? 1 : null,
                    baseline: this.baseValue,
                    roi_data: {
                        width: 200,
                        height: 150,
                        raw: roiPixels, // Mockä¼ é€’åŸå§‹æ•°æ®æ–¹ä¾¿ç»˜åˆ¶
                        gray_value: 120 + Math.random() * 10
                    }
                };
            },

            // æ¨¡æ‹Ÿæ§åˆ¶å‘½ä»¤å“åº”
            control: function(command) {
                switch(command) {
                    case 'start_detection': this.running = true; return { status: 'success' };
                    case 'stop_detection': this.running = false; return { status: 'success' };
                    case 'pause_detection': this.running = false; return { status: 'success' };
                    case 'resume_detection': this.running = true; return { status: 'success' };
                    default: return { status: 'error' };
                }
            }
        };

        /**
         * 3. APIé€šä¿¡å±‚ (API Service)
         * åŒ…å« Mock åˆ¤æ–­
         */
        const ApiService = {
            async fetchRealtimeData() {
                if (appState.mockMode) {
                    return new Promise(resolve => setTimeout(() => resolve(MockServer.getRealtimeData()), 20)); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                }
                // çœŸå® Fetch é€»è¾‘
                try {
                    // æ ¹æ®ROIé…ç½®çŠ¶æ€å†³å®šè¯·æ±‚æ•°æ®é‡
                    const count = appState.roiConfigured ? 1 : 5;
                    const response = await fetch(`${appState.serverUrl}/data/realtime?count=${count}`);
                    if(!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Fetch Error", e);
                    return null;
                }
            },

            async sendControl(command) {
                if (appState.mockMode) {
                    return Promise.resolve(MockServer.control(command));
                }
                // çœŸå®æ§åˆ¶é€»è¾‘
                const formData = new URLSearchParams();
                formData.append('command', command);
                formData.append('password', '31415'); // ç¡¬ç¼–ç å¯†ç 
                
                try {
                    const response = await fetch(`${appState.serverUrl}/control`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    return await response.json();
                } catch(e) {
                    return { status: 'error' };
                }
            },

            // ROIç›¸å…³API
            async getRoiConfig() {
                if (appState.mockMode) {
                    return Promise.resolve({
                        type: "roi_config",
                        success: true,
                        config: appState.roiConfig
                    });
                }
                try {
                    const response = await fetch(`${appState.serverUrl}/roi/config`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Get ROI config error:", e);
                    return null;
                }
            },

            async setRoiConfig(x1, y1, x2, y2) {
                if (appState.mockMode) {
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€
                    appState.roiConfig = {
                        x1: parseInt(x1), y1: parseInt(y1),
                        x2: parseInt(x2), y2: parseInt(y2),
                        center_x: Math.floor((parseInt(x1) + parseInt(x2)) / 2),
                        center_y: Math.floor((parseInt(y1) + parseInt(y2)) / 2),
                        width: Math.abs(parseInt(x2) - parseInt(x1)),
                        height: Math.abs(parseInt(y2) - parseInt(y1))
                    };
                    return Promise.resolve({
                        type: "roi_config",
                        success: true,
                        config: appState.roiConfig
                    });
                }
                const formData = new URLSearchParams();
                formData.append('x1', x1);
                formData.append('y1', y1);
                formData.append('x2', x2);
                formData.append('y2', y2);
                formData.append('password', '31415');

                try {
                    const response = await fetch(`${appState.serverUrl}/roi/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Set ROI config error:", e);
                    return { success: false, error: str(e) };
                }
            },

            async getRoiFrameRate() {
                if (appState.mockMode) {
                    return Promise.resolve({
                        type: "roi_frame_rate",
                        success: true,
                        frame_rate: appState.roiFrameRate,
                        message: `Current ROI frame rate: ${appState.roiFrameRate} FPS`
                    });
                }
                try {
                    const response = await fetch(`${appState.serverUrl}/roi/frame-rate`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Get ROI frame rate error:", e);
                    return null;
                }
            },

            async setRoiFrameRate(frameRate) {
                if (appState.mockMode) {
                    appState.roiFrameRate = frameRate;
                    // æ›´æ–°ROIæ›´æ–°é—´éš”
                    appState.roiUpdateInterval = 1000 / frameRate;
                    return Promise.resolve({
                        type: "roi_frame_rate",
                        success: true,
                        frame_rate: frameRate,
                        message: `ROI frame rate updated to ${frameRate} FPS`
                    });
                }
                const formData = new URLSearchParams();
                formData.append('frame_rate', frameRate);
                formData.append('password', '31415');

                try {
                    const response = await fetch(`${appState.serverUrl}/roi/frame-rate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Set ROI frame rate error:", e);
                    return { success: false, error: str(e) };
                }
            },

            // æ³¢å³°æ£€æµ‹é…ç½®API
            async getPeakDetectionConfig() {
                if (appState.mockMode) {
                    return Promise.resolve({
                        type: "peak_detection_config",
                        success: true,
                        threshold: 105.0,
                        margin_frames: 5,
                        difference_threshold: 2.1,
                        min_region_length: 3,
                        message: "Mock: Peak detection config retrieved"
                    });
                }

                try {
                    const response = await fetch(`${appState.serverUrl}/peak-detection/config`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Get peak detection config error:", e);
                    return { success: false, error: e.message };
                }
            },

            async setPeakDetectionConfig(config) {
                if (appState.mockMode) {
                    return Promise.resolve({
                        type: "peak_detection_config",
                        success: true,
                        ...config,
                        message: "Mock: Peak detection config updated successfully"
                    });
                }

                const formData = new URLSearchParams();
                if (config.threshold !== undefined) formData.append('threshold', config.threshold);
                if (config.margin_frames !== undefined) formData.append('margin_frames', config.margin_frames);
                if (config.difference_threshold !== undefined) formData.append('difference_threshold', config.difference_threshold);
                if (config.min_region_length !== undefined) formData.append('min_region_length', config.min_region_length);
                formData.append('password', '31415');

                try {
                    const response = await fetch(`${appState.serverUrl}/peak-detection/config`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    return await response.json();
                } catch(e) {
                    console.error("Set peak detection config error:", e);
                    return { success: false, error: e.message };
                }
            }
        };

        /**
         * 4. æ¸²æŸ“å¼•æ“ (Chart & ROI)
         */
        class WaveformChart {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d', { alpha: false }); // ä¼˜åŒ–æ€§èƒ½
                this.container = document.getElementById('chart-container');
                this.tooltip = document.getElementById('tooltip');
                
                this.resize();
                window.addEventListener('resize', () => this.resize());
                
                // æ»šè½®ç¼©æ”¾
                this.canvas.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = Math.sign(e.deltaY) * -0.1;
                    let newZoom = Math.max(0.5, Math.min(3.0, appState.chartState.zoom + delta));
                    appState.chartState.zoom = parseFloat(newZoom.toFixed(1));
                    document.getElementById('zoom-slider').value = appState.chartState.zoom;
                    document.getElementById('zoom-value').innerText = appState.chartState.zoom + 'x';
                    this.draw();
                });

                // é¼ æ ‡äº¤äº’
                this.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.canvas.addEventListener('mouseleave', () => { this.tooltip.style.display = 'none'; });
            }

            resize() {
                const rect = this.container.getBoundingClientRect();
                // å¤„ç† DPI
                const dpr = window.devicePixelRatio || 1;
                this.canvas.width = rect.width * dpr;
                this.canvas.height = rect.height * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = `${rect.width}px`;
                this.canvas.style.height = `${rect.height}px`;
                this.width = rect.width;
                this.height = rect.height;
                this.draw();
            }

            draw() {
                if (!this.ctx) return;
                
                const { width, height } = this;
                const { showGrid, showBaseline, showPoints, zoom } = appState.chartState;
                const data = appState.chartData;

                // 1. æ¸…ç©ºèƒŒæ™¯
                this.ctx.fillStyle = '#1e1e1e';
                this.ctx.fillRect(0, 0, width, height);

                // Yè½´ æ˜ å°„å‡½æ•°: å°† 0-255 æ˜ å°„åˆ° Canvas é«˜åº¦
                // æ”¾å¤§æ—¶å›´ç»•ä¸­å¿ƒç‚¹ (128) æ”¾å¤§
                const midY = height / 2;
                const scaleY = (height / 255) * zoom; 
                const mapY = (val) => midY - (val - 128) * scaleY; // ç¿»è½¬Yè½´ï¼Œå¤§å€¼åœ¨ä¸Šæ–¹

                // 2. ç»˜åˆ¶ç½‘æ ¼
                if (showGrid) {
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();
                    // ç®€å•çš„æ°´å¹³ç½‘æ ¼
                    for (let v = 0; v <= 255; v += 50) {
                        const y = mapY(v);
                        this.ctx.moveTo(0, y);
                        this.ctx.lineTo(width, y);
                    }
                    // ç®€å•çš„å‚ç›´ç½‘æ ¼
                    const step = width / 10;
                    for (let x = 0; x < width; x += step) {
                        this.ctx.moveTo(x, 0);
                        this.ctx.lineTo(x, height);
                    }
                    this.ctx.stroke();
                }

                if (data.length === 0) return;

                // Xè½´ æ­¥è¿›
                const stepX = width / (appState.maxDataPoints - 1);

                // 3. ç»˜åˆ¶åŸºçº¿
                if (showBaseline) {
                    const yBase = mapY(appState.baseline);
                    this.ctx.strokeStyle = '#dcdcaa'; // VS Code Warning Color
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(0, yBase);
                    this.ctx.lineTo(width, yBase);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                }

                // 4. ç»˜åˆ¶æ³¢å½¢
                this.ctx.strokeStyle = '#4ec9b0'; // VS Code Success/Type Color
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                
                data.forEach((pt, i) => {
                    const x = i * stepX;
                    const y = mapY(pt.value);
                    if (i === 0) this.ctx.moveTo(x, y);
                    else this.ctx.lineTo(x, y);
                });
                this.ctx.stroke();

                // 5. ç»˜åˆ¶æ•°æ®ç‚¹
                if (showPoints) {
                    this.ctx.fillStyle = '#fff';
                    data.forEach((pt, i) => {
                        const x = i * stepX;
                        const y = mapY(pt.value);
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, 2, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                }
            }

            handleMouseMove(e) {
                const rect = this.canvas.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                
                const stepX = this.width / (appState.maxDataPoints - 1);
                const index = Math.round(mouseX / stepX);

                if (index >= 0 && index < appState.chartData.length) {
                    const pt = appState.chartData[index];
                    this.tooltip.style.display = 'block';
                    this.tooltip.style.left = (e.clientX + 10) + 'px';
                    this.tooltip.style.top = (e.clientY + 10) + 'px';
                    this.tooltip.innerHTML = `T: ${pt.t.toFixed(2)}s<br>Val: ${pt.value.toFixed(1)}`;
                } else {
                    this.tooltip.style.display = 'none';
                }
            }
        }

        class RoiRenderer {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');

                // åˆ›å»ºç¦»å±Canvasç”¨äºåŒç¼“å†²
                this.offscreenCanvas = document.createElement('canvas');
                this.offscreenCanvas.width = 200;
                this.offscreenCanvas.height = 150;
                this.offscreenCtx = this.offscreenCanvas.getContext('2d');

                // å›¾åƒé¢„åŠ è½½
                this.preloadedImage = null;
                this.isLoading = false;
            }

            render(roiData) {
                if (!roiData) {
                    this.drawPlaceholder("ROIæ•°æ®æœªåˆå§‹åŒ–");
                    return;
                }

                if (appState.mockMode && roiData.raw) {
                    // Mockæ¨¡å¼ä¸‹ç›´æ¥ç»˜åˆ¶ç”Ÿæˆçš„åƒç´ æ•°æ®
                    const imgData = new ImageData(roiData.raw, 200, 150);
                    this.offscreenCtx.putImageData(imgData, 0, 0);
                    this.copyToMainCanvas();
                } else if (roiData.format === 'base64') {
                    // é¢„åŠ è½½å›¾åƒï¼Œé¿å…é—ªçƒ
                    this.preloadAndRender(roiData.pixels);
                } else if (roiData.pixels === 'roi_not_configured') {
                    this.drawPlaceholder("è¯·å…ˆé…ç½®ROIåŒºåŸŸ");
                } else if (roiData.pixels === 'roi_capture_failed') {
                    this.drawPlaceholder("ROIæˆªå›¾å¤±è´¥");
                } else if (roiData.pixels === 'roi_capture_error') {
                    this.drawPlaceholder("ROIæˆªå›¾é”™è¯¯");
                } else {
                    this.drawPlaceholder("ROIæ•°æ®æ ¼å¼: " + roiData.pixels);
                }
            }

            preloadAndRender(imageSrc) {
                // é¿å…é‡å¤åŠ è½½ç›¸åŒå›¾åƒ
                if (this.preloadedImage && this.preloadedImage.src === imageSrc) {
                    return;
                }

                if (this.isLoading) {
                    return; // å¦‚æœæ­£åœ¨åŠ è½½ï¼Œè·³è¿‡
                }

                this.isLoading = true;
                const img = new Image();

                img.onload = () => {
                    // æ¸…ç©ºç¦»å±Canvas
                    this.offscreenCtx.clearRect(0, 0, 200, 150);
                    // ç»˜åˆ¶å›¾åƒåˆ°ç¦»å±Canvas
                    this.offscreenCtx.drawImage(img, 0, 0, 200, 150);
                    // ä¸€æ¬¡æ€§å¤åˆ¶åˆ°ä¸»Canvas
                    this.copyToMainCanvas();
                    // ç¼“å­˜å›¾åƒ
                    this.preloadedImage = img;
                    this.isLoading = false;
                };

                img.onerror = () => {
                    this.isLoading = false;
                    this.drawPlaceholder("å›¾åƒåŠ è½½å¤±è´¥");
                };

                img.src = imageSrc;
            }

            copyToMainCanvas() {
                // æ¸…ç©ºä¸»Canvas
                this.ctx.clearRect(0, 0, 200, 150);
                // ä¸€æ¬¡æ€§å¤åˆ¶ç¦»å±Canvaså†…å®¹åˆ°ä¸»Canvas
                this.ctx.drawImage(this.offscreenCanvas, 0, 0);
            }

            drawPlaceholder(message) {
                // ç›´æ¥åœ¨ç¦»å±Canvasä¸Šç»˜åˆ¶
                this.drawPlaceholderToCanvas(this.offscreenCtx, message);
                // å¤åˆ¶åˆ°ä¸»Canvas
                this.copyToMainCanvas();
            }

            drawPlaceholderToCanvas(ctx, message) {
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = '#2d2d30';
                ctx.fillRect(0, 0, 200, 150);

                // ç»˜åˆ¶è¾¹æ¡†
                ctx.strokeStyle = '#3e3e42';
                ctx.strokeRect(0, 0, 200, 150);

                // ç»˜åˆ¶æ–‡å­—
                ctx.fillStyle = '#cccccc';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // å¤šè¡Œæ–‡å­—å¤„ç†
                const lines = message.split(' ');
                const lineHeight = 20;
                const startY = 75 - (lines.length - 1) * lineHeight / 2;

                lines.forEach((line, index) => {
                    ctx.fillText(line, 100, startY + index * lineHeight);
                });
            }
        }

        /**
         * 5. æ ¸å¿ƒæ§åˆ¶å™¨ (Main Controller)
         */
        const chartRenderer = new WaveformChart('waveform-chart');
        const roiRenderer = new RoiRenderer('roi-canvas');

        
        // æ›´æ–° UI å…ƒç´ 
        function updateUI() {
            // è¿æ¥çŠ¶æ€
            const connInd = document.getElementById('connection-indicator');
            const connTxt = document.getElementById('connection-text');
            if (appState.connected) {
                connInd.className = 'indicator connected';
                connTxt.innerText = 'Connected';
            } else {
                connInd.className = 'indicator disconnected';
                connTxt.innerText = 'Disconnected';
            }

            // æ•°å€¼é¢æ¿
            document.getElementById('frame-count').innerText = appState.frameCount;
            document.getElementById('current-value').innerText = appState.currentValue.toFixed(2);
            document.getElementById('baseline-value').innerText = appState.baseline.toFixed(2);
            document.getElementById('buffer-size').innerText = appState.chartData.length;
            
            // æ³¢å³°ä¿¡å·
            const peakEl = document.getElementById('peak-signal');
            if (appState.peakSignal === 1) {
                peakEl.className = 'status-value signal-green';
                peakEl.innerText = 'DETECTED';
            } else if (appState.peakSignal === 0) {
                peakEl.className = 'status-value signal-red';
                peakEl.innerText = 'WEAK';
            } else {
                peakEl.className = 'status-value signal-none';
                peakEl.innerText = 'NULL';
            }

            // ROIé…ç½®çŠ¶æ€
            const roiStatusIndicator = document.getElementById('roi-status-indicator');
            const roiStatusText = document.getElementById('roi-status-text');
            if (appState.roiConfigured) {
                roiStatusIndicator.className = 'indicator connected';
                roiStatusText.innerText = 'å·²é…ç½®';
            } else {
                roiStatusIndicator.className = 'indicator disconnected';
                roiStatusText.innerText = 'æœªé…ç½®';
            }

            // ROIæ•°æ®
            if (appState.roiData) {
                document.getElementById('roi-gray-value').innerText = appState.roiData.gray_value.toFixed(2);
            }

            // æ£€æµ‹çŠ¶æ€
            document.getElementById('detection-state').innerText = appState.detectionState;

            // æŒ‰é’®çŠ¶æ€
            const isRunning = appState.detectionState === 'RUNNING';
            const isPaused = appState.detectionState === 'PAUSED';
            const isIdle = appState.detectionState === 'IDLE' || appState.detectionState === 'STOPPED';
            const roiConfigured = appState.roiConfigured;

            // å¼€å§‹æ£€æµ‹æŒ‰é’®ï¼šéœ€è¦ROIå·²é…ç½®ä¸”ä¸åœ¨è¿è¡ŒçŠ¶æ€
            document.getElementById('start-btn').disabled = isRunning || !roiConfigured;
            document.getElementById('stop-btn').disabled = isIdle;
            document.getElementById('pause-btn').disabled = !isRunning;
            document.getElementById('resume-btn').disabled = !isPaused;

            // Update Time
            const now = new Date();
            document.getElementById('last-update').innerText = `Update: ${now.toLocaleTimeString()}`;
        }

        // åŠ¨æ€è½®è¯¢é—´éš”ç®¡ç†
        function updatePollingInterval() {
            const isRunning = appState.detectionState === 'RUNNING';
            const isPaused = appState.detectionState === 'PAUSED';

            // æ¸…é™¤å½“å‰è½®è¯¢
            if (appState.pollingIntervals.realtime) {
                clearInterval(appState.pollingIntervals.realtime);
                appState.pollingIntervals.realtime = null;
            }

            // æ ¹æ®çŠ¶æ€è®¾ç½®æ–°çš„è½®è¯¢é—´éš”
            if (isRunning || isPaused) {
                // è¿è¡Œæˆ–æš‚åœçŠ¶æ€ï¼šæ ¹æ®ROIå¸§ç‡è°ƒæ•´è½®è¯¢é¢‘ç‡
                let pollingInterval;
                if (appState.roiConfigured) {
                    // ROIå·²é…ç½®ï¼šè½®è¯¢é—´éš”ç²¾ç¡®åŒ¹é…ROIå¸§ç‡
                    pollingInterval = Math.floor(1000 / appState.roiFrameRate);
                    const updateFreq = appState.roiFrameRate;
                    document.getElementById('chart-status').innerText =
                        `System Active | ROI: ${appState.roiFrameRate}FPS | Data: ${updateFreq} points/sec`;
                } else {
                    // ROIæœªé…ç½®ï¼šä½¿ç”¨é»˜è®¤çš„é«˜é¢‘ç‡è½®è¯¢æ¨¡æ‹Ÿæ•°æ®
                    pollingInterval = 50; // 20 FPS
                    document.getElementById('chart-status').innerText = "System Active | Simulated: 20FPS";
                }
                appState.pollingIntervals.realtime = setInterval(updateRealtimeData, pollingInterval);
            } else {
                // åœæ­¢çŠ¶æ€ï¼šé™ä½é¢‘ç‡åˆ°2ç§’é—´éš”
                appState.pollingIntervals.realtime = setInterval(updateRealtimeData, 2000);
                document.getElementById('chart-status').innerText = "System Stopped | Polling: 0.5FPS";
            }
        }

        // æ ¸å¿ƒè½®è¯¢å¾ªç¯
        async function updateRealtimeData() {
            if (!appState.connected) return;

            // æ ¹æ®æ£€æµ‹çŠ¶æ€å†³å®šæ˜¯å¦è¿›è¡Œè½®è¯¢
            const isRunning = appState.detectionState === 'RUNNING';
            const isPaused = appState.detectionState === 'PAUSED';

            // å¦‚æœç³»ç»Ÿåœæ­¢ï¼Œé™ä½è½®è¯¢é¢‘ç‡æˆ–ç›´æ¥è¿”å›
            if (!isRunning && !isPaused) {
                console.log('System stopped, skipping realtime data request');
                return;
            }

            const data = await ApiService.fetchRealtimeData();
            if (data && data.type === 'realtime_data') {
                // æ›´æ–°å…¨å±€æ•°æ®
                appState.frameCount = data.frame_count;
                appState.peakSignal = data.peak_signal;
                appState.baseline = data.baseline;

                // æ§åˆ¶ROIæ›´æ–°é¢‘ç‡ - é™ä½åˆ°2 FPSï¼Œå‡å°‘é—ªçƒ
                const now = Date.now();
                if (now - appState.lastRoiUpdate > appState.roiUpdateInterval) {
                    appState.roiData = data.roi_data;
                    appState.lastRoiUpdate = now;
                }

                if (data.series && data.series.length > 0) {
                    const latest = data.series[data.series.length - 1];
                    appState.currentValue = latest.value;
                    
                    // ç»´æŠ¤å›ºå®šé•¿åº¦çš„å›¾è¡¨æ•°æ®é˜Ÿåˆ—
                    data.series.forEach(pt => {
                        appState.chartData.push(pt);
                    });
                    while (appState.chartData.length > appState.maxDataPoints) {
                        appState.chartData.shift();
                    }
                }

                // æ›´æ–°æ³¢å³°æ£€æµ‹çŠ¶æ€æ˜¾ç¤º
                if (data.enhanced_peak) {
                    updatePeakDetectionStatus(data.enhanced_peak);
                } else {
                    updatePeakDetectionStatus(null);
                }

                // æ¸²æŸ“æ›´æ–°
                chartRenderer.draw();
                roiRenderer.render(data.roi_data);
                updateUI();
            }
        }

        // çŠ¶æ€æœºæ§åˆ¶
        async function handleControl(action) {
            // æ£€æŸ¥ROIé…ç½®çŠ¶æ€ï¼ˆä»…å¯¹å¼€å§‹æ£€æµ‹ï¼‰
            if (action === 'start_detection' && !appState.roiConfigured) {
                alert('è¯·å…ˆé…ç½®ROIåŒºåŸŸåå†å¼€å§‹æ£€æµ‹ï¼');
                return;
            }

            // å…ˆä¹è§‚æ›´æ–°UI
            const oldState = appState.detectionState;

            let newState = oldState;
            if (action === 'start_detection') newState = 'RUNNING';
            if (action === 'stop_detection') newState = 'STOPPED';
            if (action === 'pause_detection') newState = 'PAUSED';
            if (action === 'resume_detection') newState = 'RUNNING';

            appState.detectionState = newState;
            updateUI();

            // å‘é€å‘½ä»¤
            const res = await ApiService.sendControl(action);
            if (res.status !== 'success') {
                alert('Command failed!');
                appState.detectionState = oldState; // å›æ»š
                updateUI();
                updatePollingInterval(); // æ¢å¤åŸæ¥çš„è½®è¯¢é—´éš”
            } else {
                // å‘½ä»¤æˆåŠŸï¼Œæ›´æ–°è½®è¯¢é—´éš”
                updatePollingInterval();
            }
        }

        // è¿æ¥é€»è¾‘
        function initConnection() {
            const ind = document.getElementById('connection-indicator');
            const txt = document.getElementById('connection-text');
            ind.className = 'indicator connecting';
            txt.innerText = 'Connecting...';

            setTimeout(async () => {
                appState.connected = true;
                updateUI();

                // åŠ è½½ROIé…ç½®
                await loadRoiConfig();

                // åŠ è½½æ³¢å³°æ£€æµ‹é…ç½®
                await loadPeakDetectionConfig();

                // å¯åŠ¨åŠ¨æ€è½®è¯¢
                updatePollingInterval();
            }, 1000);
        }

        /**
         * 5. ROIç›¸å…³å‡½æ•°
         */
        function updateRoiDisplay() {
            // è·å–è¾“å…¥å€¼
            const x1 = parseInt(document.getElementById('roi-x1').value) || 0;
            const y1 = parseInt(document.getElementById('roi-y1').value) || 0;
            const x2 = parseInt(document.getElementById('roi-x2').value) || 0;
            const y2 = parseInt(document.getElementById('roi-y2').value) || 0;

            // è®¡ç®—ä¸­å¿ƒç‚¹å’Œå°ºå¯¸
            const centerX = Math.floor((x1 + x2) / 2);
            const centerY = Math.floor((y1 + y2) / 2);
            const width = Math.abs(x2 - x1);
            const height = Math.abs(y2 - y1);

            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('roi-center').textContent = `(${centerX}, ${centerY})`;
            document.getElementById('roi-width').textContent = `${width} px`;
            document.getElementById('roi-height').textContent = `${height} px`;
        }

        async function applyRoiConfig() {
            try {
                const x1 = parseInt(document.getElementById('roi-x1').value) || 0;
                const y1 = parseInt(document.getElementById('roi-y1').value) || 0;
                const x2 = parseInt(document.getElementById('roi-x2').value) || 0;
                const y2 = parseInt(document.getElementById('roi-y2').value) || 0;
                const frameRate = parseInt(document.getElementById('roi-frame-rate').value) || 2;

                // åŸºæœ¬éªŒè¯
                if (x1 >= x2 || y1 >= y2) {
                    alert('ROIåæ ‡æ— æ•ˆï¼šx1å¿…é¡»å°äºx2ï¼Œy1å¿…é¡»å°äºy2');
                    return;
                }

                if (x2 - x1 < 10 || y2 - y1 < 10) {
                    alert('ROIå°ºå¯¸å¤ªå°ï¼šæœ€å°å°ºå¯¸ä¸º10x10åƒç´ ');
                    return;
                }

                if (frameRate < 1 || frameRate > 60) {
                    alert('å¸§ç‡æ— æ•ˆï¼šå¿…é¡»åœ¨1-60ä¹‹é—´');
                    return;
                }

                // åŒæ—¶åº”ç”¨ROIé…ç½®å’Œå¸§ç‡è®¾ç½®
                const [roiResponse, frameRateResponse] = await Promise.all([
                    ApiService.setRoiConfig(x1, y1, x2, y2),
                    ApiService.setRoiFrameRate(frameRate)
                ]);

                // æ£€æŸ¥ROIé…ç½®ç»“æœ
                if (roiResponse && roiResponse.success) {
                    // æ›´æ–°æœ¬åœ°çŠ¶æ€
                    appState.roiConfig = roiResponse.config;
                    appState.roiConfigured = true;
                    console.log('ROIé…ç½®åº”ç”¨æˆåŠŸ:', roiResponse.config);
                } else {
                    alert('ROIé…ç½®åº”ç”¨å¤±è´¥: ' + (roiResponse?.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }

                // æ£€æŸ¥å¸§ç‡è®¾ç½®ç»“æœ
                if (frameRateResponse && frameRateResponse.success) {
                    console.log('ROIå¸§ç‡è®¾ç½®æˆåŠŸ:', frameRateResponse.frame_rate);
                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    appState.roiFrameRate = frameRate;
                    appState.roiUpdateInterval = Math.floor(1000 / frameRate);
                    updateRoiFrameRateDisplay();
                } else {
                    console.warn('ROIå¸§ç‡è®¾ç½®å¤±è´¥: ' + (frameRateResponse?.error || 'æœªçŸ¥é”™è¯¯'));
                }

                updateUI();  // æ›´æ–°UIçŠ¶æ€
            } catch (error) {
                console.error('Apply ROI config error:', error);
                alert('ROIé…ç½®åº”ç”¨å¤±è´¥: ' + error.message);
            }
        }

        
        async function loadRoiConfig() {
            try {
                const response = await ApiService.getRoiConfig();
                if (response && response.success && response.config) {
                    appState.roiConfig = response.config;
                    // å¦‚æœé…ç½®ä¸æ˜¯é»˜è®¤å€¼ï¼Œåˆ™è®¤ä¸ºå·²é…ç½®
                    const isDefaultConfig = (response.config.x1 === 0 && response.config.y1 === 0 &&
                                            response.config.x2 === 200 && response.config.y2 === 150);
                    appState.roiConfigured = !isDefaultConfig;

                    // æ›´æ–°UIè¾“å…¥æ¡†
                    document.getElementById('roi-x1').value = response.config.x1;
                    document.getElementById('roi-y1').value = response.config.y1;
                    document.getElementById('roi-x2').value = response.config.x2;
                    document.getElementById('roi-y2').value = response.config.y2;

                    // æ›´æ–°æ˜¾ç¤º
                    updateRoiDisplay();

                    console.log('ROIé…ç½®åŠ è½½æˆåŠŸ:', response.config, 'é…ç½®çŠ¶æ€:', appState.roiConfigured);
                }

                // åŠ è½½ROIå¸§ç‡è®¾ç½®
                await loadRoiFrameRate();
            } catch (error) {
                console.error('åŠ è½½ROIé…ç½®å¤±è´¥:', error);
            }
        }

        async function loadRoiFrameRate() {
            try {
                const response = await ApiService.getRoiFrameRate();
                if (response && response.success) {
                    document.getElementById('roi-frame-rate').value = response.frame_rate;
                    document.getElementById('roi-fps-display').textContent = `${response.frame_rate} FPS`;
                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    appState.roiFrameRate = response.frame_rate;
                    appState.roiUpdateInterval = Math.floor(1000 / response.frame_rate);
                    console.log('ROIå¸§ç‡åŠ è½½æˆåŠŸ:', response.frame_rate);
                }
            } catch (error) {
                console.error('åŠ è½½ROIå¸§ç‡å¤±è´¥:', error);
            }
        }

        /**
         * 7. æ³¢å³°æ£€æµ‹é…ç½®å‡½æ•°
         */
        function savePeakDetectionConfigToLocalStorage(config) {
            try {
                const data = {
                    ...config,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('newfem_peak_detection_config', JSON.stringify(data));
                console.log('Peak detection config saved to localStorage:', data);
            } catch (error) {
                console.warn('Failed to save peak detection config to localStorage:', error);
            }
        }

        function loadPeakDetectionConfigFromLocalStorage() {
            try {
                const stored = localStorage.getItem('newfem_peak_detection_config');
                if (stored) {
                    const config = JSON.parse(stored);
                    console.log('Peak detection config loaded from localStorage:', config);
                    return config;
                }
                return null;
            } catch (error) {
                console.warn('Failed to load peak detection config from localStorage:', error);
                return null;
            }
        }

        async function loadPeakDetectionConfig() {
            try {
                // é¦–å…ˆå°è¯•ä»localStorageåŠ è½½é…ç½®
                let localConfig = loadPeakDetectionConfigFromLocalStorage();

                if (localConfig) {
                    // ä½¿ç”¨æœ¬åœ°é…ç½®æ›´æ–°UI
                    document.getElementById('peak-threshold').value = localConfig.threshold;
                    document.getElementById('peak-margin-frames').value = localConfig.margin_frames;
                    document.getElementById('peak-difference-threshold').value = localConfig.difference_threshold;
                    document.getElementById('peak-min-region-length').value = localConfig.min_region_length;

                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    appState.peakConfig = {
                        threshold: localConfig.threshold,
                        margin_frames: localConfig.margin_frames,
                        difference_threshold: localConfig.difference_threshold,
                        min_region_length: localConfig.min_region_length
                    };

                    // åŒæ—¶åº”ç”¨åˆ°åç«¯ä»¥ä¿æŒåŒæ­¥
                    const backendResponse = await ApiService.setPeakDetectionConfig({
                        threshold: localConfig.threshold,
                        margin_frames: localConfig.margin_frames,
                        difference_threshold: localConfig.difference_threshold,
                        min_region_length: localConfig.min_region_length
                    });

                    if (backendResponse && backendResponse.success) {
                        console.log('æ³¢å³°æ£€æµ‹é…ç½®ä»æœ¬åœ°åŠ è½½å¹¶åŒæ­¥åˆ°åç«¯æˆåŠŸ:', localConfig);
                    } else {
                        console.warn('æ³¢å³°æ£€æµ‹é…ç½®ä»æœ¬åœ°åŠ è½½ä½†åŒæ­¥åˆ°åç«¯å¤±è´¥:', backendResponse?.error);
                    }
                } else {
                    // æœ¬åœ°æ— é…ç½®ï¼Œä»APIåŠ è½½é»˜è®¤é…ç½®
                    const response = await ApiService.getPeakDetectionConfig();
                    if (response && response.success) {
                        // æ›´æ–°UIè¾“å…¥æ¡†
                        document.getElementById('peak-threshold').value = response.threshold;
                        document.getElementById('peak-margin-frames').value = response.margin_frames;
                        document.getElementById('peak-difference-threshold').value = response.difference_threshold;
                        document.getElementById('peak-min-region-length').value = response.min_region_length;

                        // æ›´æ–°åº”ç”¨çŠ¶æ€
                        appState.peakConfig = {
                            threshold: response.threshold,
                            margin_frames: response.margin_frames,
                            difference_threshold: response.difference_threshold,
                            min_region_length: response.min_region_length
                        };

                        // ä¿å­˜åˆ°localStorageä¾›ä¸‹æ¬¡ä½¿ç”¨
                        savePeakDetectionConfigToLocalStorage(appState.peakConfig);

                        console.log('æ³¢å³°æ£€æµ‹é…ç½®ä»APIåŠ è½½æˆåŠŸ:', response);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ³¢å³°æ£€æµ‹é…ç½®å¤±è´¥:', error);
                // å‘ç”Ÿé”™è¯¯æ—¶ä½¿ç”¨é»˜è®¤é…ç½®
                const defaultConfig = appState.peakConfig;
                document.getElementById('peak-threshold').value = defaultConfig.threshold;
                document.getElementById('peak-margin-frames').value = defaultConfig.margin_frames;
                document.getElementById('peak-difference-threshold').value = defaultConfig.difference_threshold;
                document.getElementById('peak-min-region-length').value = defaultConfig.min_region_length;
            }
        }

        async function applyPeakDetectionConfig() {
            try {
                const threshold = parseFloat(document.getElementById('peak-threshold').value) || 105.0;
                const marginFrames = parseInt(document.getElementById('peak-margin-frames').value) || 5;
                const differenceThreshold = parseFloat(document.getElementById('peak-difference-threshold').value) || 2.1;
                const minRegionLength = parseInt(document.getElementById('peak-min-region-length').value) || 3;

                // éªŒè¯å‚æ•°èŒƒå›´
                if (threshold < 50.0 || threshold > 255.0) {
                    alert('ç»å¯¹é˜ˆå€¼æ— æ•ˆï¼šå¿…é¡»åœ¨50.0-255.0ä¹‹é—´');
                    return;
                }

                if (marginFrames < 1 || marginFrames > 20) {
                    alert('è¾¹ç•Œæ‰©å±•å¸§æ•°æ— æ•ˆï¼šå¿…é¡»åœ¨1-20ä¹‹é—´');
                    return;
                }

                if (differenceThreshold < 0.1 || differenceThreshold > 10.0) {
                    alert('é¢œè‰²åˆ†ç±»é˜ˆå€¼æ— æ•ˆï¼šå¿…é¡»åœ¨0.1-10.0ä¹‹é—´');
                    return;
                }

                if (minRegionLength < 1 || minRegionLength > 20) {
                    alert('æœ€å°åŒºåŸŸé•¿åº¦æ— æ•ˆï¼šå¿…é¡»åœ¨1-20ä¹‹é—´');
                    return;
                }

                // å‘é€APIè¯·æ±‚
                const config = {
                    threshold: threshold,
                    margin_frames: marginFrames,
                    difference_threshold: differenceThreshold,
                    min_region_length: minRegionLength
                };

                const response = await ApiService.setPeakDetectionConfig(config);
                if (response && response.success) {
                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    appState.peakConfig = config;

                    // ä¿å­˜é…ç½®åˆ°localStorage
                    savePeakDetectionConfigToLocalStorage(config);

                    console.log('æ³¢å³°æ£€æµ‹é…ç½®åº”ç”¨æˆåŠŸ:', response);
                    // ç§»é™¤æˆåŠŸå¼¹æ¡†ï¼Œå®ç°æ— å¹²æ‰°åº”ç”¨
                } else {
                    alert('æ³¢å³°æ£€æµ‹é…ç½®åº”ç”¨å¤±è´¥: ' + (response?.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('Apply peak detection config error:', error);
                alert('æ³¢å³°æ£€æµ‹é…ç½®åº”ç”¨å¤±è´¥: ' + error.message);
            }
        }

        function updatePeakDetectionStatus(peakData) {
            if (!peakData) {
                document.getElementById('peak-status-indicator').className = 'indicator disconnected';
                document.getElementById('peak-status-text').textContent = 'æœªæ¿€æ´»';
                document.getElementById('current-peak-color').innerHTML = '<span class="status-value">-</span>';
                return;
            }

            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            if (peakData.signal === 1) {
                document.getElementById('peak-status-indicator').className = 'indicator running';
                document.getElementById('peak-status-text').textContent = 'æ£€æµ‹åˆ°æ³¢å³°';

                // æ›´æ–°é¢œè‰²æ˜¾ç¤º
                if (peakData.color === 'green') {
                    document.getElementById('current-peak-color').innerHTML =
                        '<span style="color: #4ec9b0; font-weight: bold;">ğŸŸ¢ ç»¿è‰²æ³¢å³° (ç¨³å®š)</span>';
                } else if (peakData.color === 'red') {
                    document.getElementById('current-peak-color').innerHTML =
                        '<span style="color: #f44747; font-weight: bold;">ğŸ”´ çº¢è‰²æ³¢å³° (å¯èƒ½ä¸ç¨³å®š)</span>';
                } else {
                    document.getElementById('current-peak-color').innerHTML =
                        '<span class="status-value">æ³¢å³° (é¢œè‰²æœªçŸ¥)</span>';
                }
            } else {
                document.getElementById('peak-status-indicator').className = 'indicator connecting';
                document.getElementById('peak-status-text').textContent = 'ç›‘æ§ä¸­';
                document.getElementById('current-peak-color').innerHTML = '<span class="status-value">-</span>';
            }
        }

        function updateRoiFrameRateDisplay() {
            const frameRate = parseInt(document.getElementById('roi-frame-rate').value) || 2;
            document.getElementById('roi-fps-display').textContent = `${frameRate} FPS`;
        }

        async function applyRoiFrameRate() {
            try {
                const frameRate = parseInt(document.getElementById('roi-frame-rate').value) || 2;

                // éªŒè¯å¸§ç‡èŒƒå›´
                if (frameRate < 1 || frameRate > 60) {
                    alert('å¸§ç‡æ— æ•ˆï¼šå¿…é¡»åœ¨1-60ä¹‹é—´');
                    return;
                }

                // å‘é€APIè¯·æ±‚
                const response = await ApiService.setRoiFrameRate(frameRate);
                if (response && response.success) {
                    console.log('ROIå¸§ç‡è®¾ç½®æˆåŠŸ:', response.frame_rate);
                    // æ›´æ–°åº”ç”¨çŠ¶æ€
                    appState.roiFrameRate = frameRate;
                    appState.roiUpdateInterval = Math.floor(1000 / frameRate);
                    // æ›´æ–°æ˜¾ç¤º
                    updateRoiFrameRateDisplay();
                    // å¦‚æœç³»ç»Ÿæ­£åœ¨è¿è¡Œï¼Œé‡æ–°è®¾ç½®è½®è¯¢é—´éš”ä»¥åº”ç”¨æ–°çš„å¸§ç‡
                    if (appState.detectionState === 'RUNNING' || appState.detectionState === 'PAUSED') {
                        updatePollingInterval();
                    }
                } else {
                    alert('ROIå¸§ç‡è®¾ç½®å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('Apply ROI frame rate error:', error);
                alert('ROIå¸§ç‡è®¾ç½®å¤±è´¥: ' + error.message);
            }
        }

        /**
         * 6. äº‹ä»¶ç»‘å®š
         */
        document.addEventListener('DOMContentLoaded', () => {
            // æ˜¾ç¤ºæ§åˆ¶
            document.getElementById('show-grid').addEventListener('change', (e) => {
                appState.chartState.showGrid = e.target.checked;
                chartRenderer.draw();
            });
            document.getElementById('show-baseline').addEventListener('change', (e) => {
                appState.chartState.showBaseline = e.target.checked;
                chartRenderer.draw();
            });
            document.getElementById('show-points').addEventListener('change', (e) => {
                appState.chartState.showPoints = e.target.checked;
                chartRenderer.draw();
            });
            
            // ç¼©æ”¾æ§åˆ¶
            const zoomSlider = document.getElementById('zoom-slider');
            const zoomVal = document.getElementById('zoom-value');
            zoomSlider.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                appState.chartState.zoom = val;
                zoomVal.innerText = val + 'x';
                chartRenderer.draw();
            });

            // æ£€æµ‹æ§åˆ¶
            document.getElementById('start-btn').addEventListener('click', () => handleControl('start_detection'));
            document.getElementById('stop-btn').addEventListener('click', () => handleControl('stop_detection'));
            document.getElementById('pause-btn').addEventListener('click', () => handleControl('pause_detection'));
            document.getElementById('resume-btn').addEventListener('click', () => handleControl('resume_detection'));

            // ROIè®¾ç½®æ§åˆ¶
            const roiInputs = ['roi-x1', 'roi-y1', 'roi-x2', 'roi-y2'];
            roiInputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateRoiDisplay);
            });

            document.getElementById('apply-roi-btn').addEventListener('click', applyRoiConfig);

            // ROIå¸§ç‡æ§åˆ¶
            document.getElementById('roi-frame-rate').addEventListener('input', updateRoiFrameRateDisplay);
            document.getElementById('roi-frame-rate').addEventListener('change', applyRoiFrameRate);

            // æ³¢å³°æ£€æµ‹é…ç½®æ§åˆ¶
            document.getElementById('apply-peak-config-btn').addEventListener('click', applyPeakDetectionConfig);

            // å¯åŠ¨
            initConnection();
        });

    </script>
</body>
</html>