<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢å½¢æˆªå–åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #1e1e1e;
            color: #cccccc;
            margin: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #252526;
        }
        .capture-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        .capture-controls input {
            padding: 8px;
            border: 1px solid #3e3e42;
            background-color: #3c3c3c;
            color: #cccccc;
            border-radius: 4px;
            width: 100px;
        }
        .capture-controls button {
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .capture-controls button:hover {
            background-color: #0062a3;
        }
        .main-chart, .captured-chart {
            border: 1px solid #3e3e42;
            background-color: #1e1e1e;
            border-radius: 4px;
            margin: 10px 0;
        }
        .chart-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #ffffff;
        }
        .status-info {
            background-color: #3c3c3c;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
        }
        .instructions {
            background-color: #2d2d30;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .test-success {
            color: #4ec9b0;
            background-color: rgba(78, 201, 176, 0.1);
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="instructions">
            <h2>æ³¢å½¢æˆªå–åŠŸèƒ½æµ‹è¯•é¡µé¢</h2>
            <p>æ­¤é¡µé¢ç”¨äºæµ‹è¯•æ–°æ·»åŠ çš„æ³¢å½¢æˆªå–åŠŸèƒ½ï¼ŒéªŒè¯ä»¥ä¸‹åŠŸèƒ½ï¼š</p>
            <ul>
                <li>æˆªå–çª—å£å¤§å°è®¾ç½®ï¼ˆé»˜è®¤100å¸§ï¼‰</li>
                <li>åŠ¨æ€ç”Ÿæˆæ¨¡æ‹Ÿæ³¢å½¢æ•°æ®</li>
                <li>æˆªå–æŒ‡å®šå¸§æ•°çš„æ³¢å½¢æ•°æ®</li>
                <li>é™æ€æ˜¾ç¤ºæˆªå–çš„æ³¢å½¢</li>
                <li>æ¸…é™¤æˆªå–åŠŸèƒ½</li>
                <li>ä¸»æ›²çº¿ä¸æˆªå–æ›²çº¿çš„ç‹¬ç«‹æ€§</li>
            </ul>
        </div>

        <div class="test-section">
            <div class="chart-title">ä¸»æ³¢å½¢å›¾ï¼ˆå®æ—¶æ›´æ–°ï¼‰</div>
            <canvas id="main-chart" class="main-chart" width="760" height="300"></canvas>
            <div class="status-info" id="main-info">
                ç­‰å¾…å¯åŠ¨æ•°æ®ç”Ÿæˆ...
            </div>
        </div>

        <div class="test-section">
            <div class="chart-title">æ³¢å½¢æˆªå–æ§åˆ¶</div>
            <div class="capture-controls">
                <label>çª—å£å¤§å°ï¼ˆå¸§ï¼‰:</label>
                <input type="number" id="window-size" value="100" min="1" max="500">
                <button id="capture-btn">æˆªå–æ³¢å½¢</button>
                <button id="clear-btn">æ¸…é™¤æˆªå–</button>
                <button id="start-data-btn">å¼€å§‹æ•°æ®ç”Ÿæˆ</button>
                <button id="stop-data-btn">åœæ­¢æ•°æ®ç”Ÿæˆ</button>
            </div>
            <div class="status-info" id="capture-status">
                å°šæœªè¿›è¡Œæˆªå–...
            </div>
        </div>

        <div class="test-section" id="captured-section" style="display: none;">
            <div class="chart-title">æˆªå–çš„æ³¢å½¢ï¼ˆé™æ€æ˜¾ç¤ºï¼‰</div>
            <canvas id="captured-chart" class="captured-chart" width="760" height="200"></canvas>
            <div class="status-info" id="captured-info">
                æˆªå–ä¿¡æ¯ï¼š-
            </div>
        </div>

        <div class="test-success" id="test-result" style="display: none;">
            âœ… æ³¢å½¢æˆªå–åŠŸèƒ½æµ‹è¯•å®Œæˆï¼æ‰€æœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œã€‚
        </div>
    </div>

    <script>
        // æµ‹è¯•çŠ¶æ€
        const testState = {
            mainData: [],
            capturedData: null,
            isGenerating: false,
            frameCount: 0,
            animationId: null
        };

        // è·å–ç”»å¸ƒä¸Šä¸‹æ–‡
        const mainCanvas = document.getElementById('main-chart');
        const mainCtx = mainCanvas.getContext('2d');
        const capturedCanvas = document.getElementById('captured-chart');
        const capturedCtx = capturedCanvas.getContext('2d');

        // ç»˜åˆ¶ä¸»æ³¢å½¢
        function drawMainChart() {
            const ctx = mainCtx;
            const width = mainCanvas.width;
            const height = mainCanvas.height;

            // æ¸…ç©ºèƒŒæ™¯
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, width, height);

            if (testState.mainData.length === 0) return;

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= 10; i++) {
                const y = (height / 10) * i;
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
            }
            for (let i = 0; i <= 20; i++) {
                const x = (width / 20) * i;
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
            }
            ctx.stroke();

            // ç»˜åˆ¶åŸºçº¿
            const baselineY = height - (120 / 255) * height;
            ctx.strokeStyle = '#dcdcaa';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, baselineY);
            ctx.lineTo(width, baselineY);
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶æ³¢å½¢
            ctx.strokeStyle = '#4ec9b0';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const maxPoints = 200;
            const stepX = width / (maxPoints - 1);

            testState.mainData.slice(-maxPoints).forEach((pt, i) => {
                const x = i * stepX;
                const y = height - (pt.value / 255) * height;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // æ›´æ–°ä¿¡æ¯
            document.getElementById('main-info').textContent =
                `å¸§æ•°: ${testState.frameCount} | æ•°æ®ç‚¹: ${testState.mainData.length} | å½“å‰å€¼: ${testState.mainData[testState.mainData.length - 1]?.value.toFixed(1) || 0}`;
        }

        // ç»˜åˆ¶æˆªå–çš„æ³¢å½¢
        function drawCapturedChart() {
            const ctx = capturedCtx;
            const width = capturedCanvas.width;
            const height = capturedCanvas.height;

            // æ¸…ç©ºèƒŒæ™¯
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, width, height);

            if (!testState.capturedData || testState.capturedData.length === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ— æˆªå–æ•°æ®', width / 2, height / 2);
                return;
            }

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= 10; i++) {
                const y = (height / 10) * i;
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
            }
            for (let i = 0; i <= 10; i++) {
                const x = (width / 10) * i;
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
            }
            ctx.stroke();

            // ç»˜åˆ¶åŸºçº¿
            const baselineY = height - (120 / 255) * height;
            ctx.strokeStyle = '#dcdcaa';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, baselineY);
            ctx.lineTo(width, baselineY);
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶æˆªå–çš„æ³¢å½¢
            ctx.strokeStyle = '#4ec9b0';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const stepX = width / (testState.capturedData.length - 1);

            testState.capturedData.forEach((pt, i) => {
                const x = i * stepX;
                const y = height - (pt.value / 255) * height;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // ç»˜åˆ¶æ•°æ®ç‚¹
            ctx.fillStyle = '#fff';
            testState.capturedData.forEach((pt, i) => {
                const x = i * stepX;
                const y = height - (pt.value / 255) * height;
                ctx.beginPath();
                ctx.arc(x, y, 2, 0, Math.PI * 2);
                ctx.fill();
            });

            // æ›´æ–°ä¿¡æ¯
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('captured-info').textContent =
                `æˆªå–å¸§æ•°: ${testState.capturedData.length} | æˆªå–æ—¶é—´: ${timestamp} | é¦–å€¼: ${testState.capturedData[0].value.toFixed(1)} | æœ«å€¼: ${testState.capturedData[testState.capturedData.length - 1].value.toFixed(1)}`;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
        function generateData() {
            if (!testState.isGenerating) return;

            testState.frameCount++;
            const t = testState.frameCount * 0.1;
            let value = 120 + Math.sin(t) * 10 + (Math.random() - 0.5) * 5;

            // å¶å°”ç”Ÿæˆæ³¢å³°
            if (Math.random() > 0.95) {
                value += 40;
            }

            testState.mainData.push({ t, value });

            // ä¿æŒå›ºå®šé•¿åº¦çš„æ•°æ®
            if (testState.mainData.length > 200) {
                testState.mainData.shift();
            }

            drawMainChart();
            testState.animationId = requestAnimationFrame(generateData);
        }

        // æˆªå–æ³¢å½¢
        function captureWaveform() {
            const windowSize = parseInt(document.getElementById('window-size').value) || 100;

            if (testState.mainData.length === 0) {
                alert('æ²¡æœ‰å¯æˆªå–çš„æ•°æ®ï¼è¯·å…ˆå¼€å§‹æ•°æ®ç”Ÿæˆã€‚');
                return;
            }

            const actualFrameCount = Math.min(windowSize, testState.mainData.length);
            const startIndex = testState.mainData.length - actualFrameCount;

            // æ·±æ‹·è´æ•°æ®
            testState.capturedData = testState.mainData.slice(startIndex).map(pt => ({
                ...pt,
                t: pt.t - testState.mainData[startIndex].t
            }));

            // æ˜¾ç¤ºæˆªå–åŒºåŸŸ
            document.getElementById('captured-section').style.display = 'block';
            document.getElementById('capture-status').textContent =
                `âœ… æˆåŠŸæˆªå– ${actualFrameCount} å¸§ï¼ˆä» ${testState.mainData.length} å¸§ä¸­æˆªå–ï¼‰`;

            drawCapturedChart();

            // æ£€æŸ¥æµ‹è¯•å®Œæˆ
            checkTestCompletion();
        }

        // æ¸…é™¤æˆªå–
        function clearCapture() {
            testState.capturedData = null;
            document.getElementById('captured-section').style.display = 'none';
            document.getElementById('capture-status').textContent = 'æˆªå–å·²æ¸…é™¤';

            // æ¸…ç©ºæˆªå–ç”»å¸ƒ
            const ctx = capturedCtx;
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, capturedCanvas.width, capturedCanvas.height);
        }

        // å¼€å§‹æ•°æ®ç”Ÿæˆ
        function startDataGeneration() {
            if (testState.isGenerating) return;

            testState.isGenerating = true;
            generateData();
            document.getElementById('capture-status').textContent = 'ğŸ“¡ æ•°æ®ç”Ÿæˆå·²å¼€å§‹...';
        }

        // åœæ­¢æ•°æ®ç”Ÿæˆ
        function stopDataGeneration() {
            testState.isGenerating = false;
            if (testState.animationId) {
                cancelAnimationFrame(testState.animationId);
            }
            document.getElementById('capture-status').textContent = 'â¹ï¸ æ•°æ®ç”Ÿæˆå·²åœæ­¢';
        }

        // æ£€æŸ¥æµ‹è¯•å®Œæˆ
        function checkTestCompletion() {
            if (testState.capturedData && testState.capturedData.length > 0) {
                document.getElementById('test-result').style.display = 'block';
            }
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('capture-btn').addEventListener('click', captureWaveform);
        document.getElementById('clear-btn').addEventListener('click', clearCapture);
        document.getElementById('start-data-btn').addEventListener('click', startDataGeneration);
        document.getElementById('stop-data-btn').addEventListener('click', stopDataGeneration);

        // åˆå§‹åŒ–
        drawMainChart();
        drawCapturedChart();

        // è‡ªåŠ¨å¼€å§‹æ•°æ®ç”Ÿæˆç”¨äºæµ‹è¯•
        setTimeout(() => {
            startDataGeneration();
        }, 1000);
    </script>
</body>
</html>