<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æ³¢å½¢æˆªå–åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e1e1e;
            color: #cccccc;
            margin: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background-color: #252526;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #3e3e42;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .panel {
            background-color: #252526;
            border: 1px solid #3e3e42;
            border-radius: 8px;
            padding: 20px;
        }
        .panel h3 {
            margin-top: 0;
            color: #ffffff;
            border-bottom: 1px solid #3e3e42;
            padding-bottom: 10px;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        button {
            padding: 8px 16px;
            background-color: #007acc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        button:hover {
            background-color: #0062a3;
        }
        button:disabled {
            background-color: #3a3a3a;
            cursor: not-allowed;
        }
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .input-group label {
            min-width: 100px;
        }
        .input-group input {
            background-color: #3c3c3c;
            border: 1px solid #3e3e42;
            color: #cccccc;
            padding: 4px 8px;
            border-radius: 4px;
            width: 100px;
        }
        .canvas-container {
            border: 1px solid #3e3e42;
            background-color: #1e1e1e;
            border-radius: 4px;
            margin: 10px 0;
            padding: 10px;
            min-height: 200px;
        }
        canvas {
            display: block;
            width: 100%;
            border-radius: 4px;
        }
        .status-bar {
            background-color: #2d2d30;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 10px;
        }
        .success {
            color: #4ec9b0;
        }
        .error {
            color: #f48771;
        }
        .warning {
            color: #dcdcaa;
        }
        .capture-section {
            grid-column: 1 / -1;
        }
        .debug-output {
            background-color: #2d2d30;
            border: 1px solid #3e3e42;
            border-radius: 4px;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        .feature-list {
            background-color: #2d2d30;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .feature-list h4 {
            margin-top: 0;
            color: #4ec9b0;
        }
        .feature-list ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .feature-list li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ NewFEM æ³¢å½¢æˆªå–åŠŸèƒ½å®Œæ•´æµ‹è¯•</h1>
            <div class="feature-list">
                <h4>âœ… å·²ä¿®å¤çš„é—®é¢˜</h4>
                <ul>
                    <li>Canvas resize åè‡ªåŠ¨é‡ç»˜</li>
                    <li>Canvas ä¸Šä¸‹æ–‡éªŒè¯å’Œé”™è¯¯å¤„ç†</li>
                    <li>æ•°æ®ç»“æ„éªŒè¯å’Œè°ƒè¯•æ—¥å¿—</li>
                    <li>æ˜¾ç¤ºæµç¨‹æ—¶åºé—®é¢˜ï¼ˆDOM æ›´æ–°åæ¸²æŸ“ï¼‰</li>
                    <li>åç«¯é”™è¯¯ä¿®å¤ï¼ˆcreate_roi_data_with_imageï¼‰</li>
                </ul>
            </div>
        </div>

        <div class="main-content">
            <!-- æ¨¡æ‹Ÿä¸»å›¾è¡¨ -->
            <div class="panel">
                <h3>ğŸ“Š ä¸»æ³¢å½¢å›¾ï¼ˆæ¨¡æ‹Ÿå®æ—¶æ•°æ®ï¼‰</h3>
                <div class="controls">
                    <button id="start-simulation">å¼€å§‹æ¨¡æ‹Ÿ</button>
                    <button id="stop-simulation">åœæ­¢æ¨¡æ‹Ÿ</button>
                    <button id="clear-data">æ¸…ç©ºæ•°æ®</button>
                </div>
                <div class="canvas-container">
                    <canvas id="main-chart" width="400" height="200"></canvas>
                </div>
                <div class="status-bar" id="main-status">
                    çŠ¶æ€: å¾…æœº | æ•°æ®ç‚¹: 0 | FPS: 0
                </div>
            </div>

            <!-- æˆªå–æ§åˆ¶é¢æ¿ -->
            <div class="panel">
                <h3>ğŸ›ï¸ æˆªå–æ§åˆ¶é¢æ¿</h3>
                <div class="input-group">
                    <label>çª—å£å¤§å°:</label>
                    <input type="number" id="window-size" value="50" min="1" max="200">
                    <span>å¸§</span>
                </div>
                <div class="controls">
                    <button id="capture-btn">æˆªå–æ³¢å½¢</button>
                    <button id="clear-capture-btn">æ¸…é™¤æˆªå–</button>
                </div>
                <div class="status-bar" id="capture-status">
                    ç­‰å¾…æˆªå–...
                </div>
                <div class="debug-output" id="debug-output">
                    ç­‰å¾…æ“ä½œ...
                </div>
            </div>

            <!-- æˆªå–ç»“æœæ˜¾ç¤º -->
            <div class="panel capture-section">
                <h3>ğŸ“¸ æˆªå–çš„æ³¢å½¢ï¼ˆé™æ€æ˜¾ç¤ºï¼‰</h3>
                <div id="captured-section" style="display: none;">
                    <div class="status-bar success" id="capture-info">
                        æˆªå–ä¿¡æ¯: -
                    </div>
                    <div class="canvas-container">
                        <canvas id="captured-chart" width="800" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•çŠ¶æ€ç®¡ç†
        const testState = {
            mainData: [],
            capturedData: null,
            isSimulating: false,
            frameCount: 0,
            animationId: null
        };

        // é‡å®šå‘æ§åˆ¶å°è¾“å‡ºåˆ°é¡µé¢
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function logToPage(...args) {
            const output = document.getElementById('debug-output');
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg =>
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage('â„¹ï¸', ...args);
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            logToPage('âŒ', ...args);
        };

        console.warn = function(...args) {
            originalWarn.apply(console, args);
            logToPage('âš ï¸', ...args);
        };

        // CapturedWaveform ç±»ï¼ˆä¸ä¿®å¤åçš„å®ç°ä¸€è‡´ï¼‰
        class CapturedWaveform {
            constructor(canvasId) {
                console.log(`CapturedWaveform: åˆå§‹åŒ–ç”»å¸ƒ ${canvasId}`);

                this.canvas = document.getElementById(canvasId);

                if (!this.canvas) {
                    console.error(`CapturedWaveform: Canvas element with id '${canvasId}' not found`);
                    return;
                }

                this.ctx = this.canvas.getContext('2d', { alpha: false });
                if (!this.ctx) {
                    console.error('CapturedWaveform: Failed to get 2D context');
                    return;
                }

                console.log('âœ… CapturedWaveform: Canvas initialized successfully');

                this.resize();

                this.config = {
                    showGrid: true,
                    showBaseline: true,
                    showPoints: true,
                    zoom: 1.0
                };
            }

            resize() {
                const rect = this.canvas.getBoundingClientRect();
                const dpr = window.devicePixelRatio || 1;

                this.canvas.width = rect.width * dpr;
                this.canvas.height = 200 * dpr;
                this.ctx.scale(dpr, dpr);
                this.canvas.style.width = `${rect.width}px`;
                this.canvas.style.height = '200px';

                this.width = rect.width;
                this.height = 200;

                // å¦‚æœæœ‰æ•è·çš„æ•°æ®ï¼Œé‡æ–°ç»˜åˆ¶
                if (testState.capturedData && testState.capturedData.length > 0) {
                    this.draw(testState.capturedData);
                }
            }

            draw(data) {
                console.log('ğŸ¨ CapturedWaveform.draw() called with data:', data ? `${data.length} points` : 'null');

                if (!this.ctx) {
                    console.error('âŒ CapturedWaveform: Canvas context not available');
                    return;
                }

                if (!data) {
                    console.warn('âš ï¸ CapturedWaveform: No data provided');
                    this.drawPlaceholder("æ— æ•°æ®");
                    return;
                }

                if (!Array.isArray(data) || data.length === 0) {
                    console.warn('âš ï¸ CapturedWaveform: Data is not an array or is empty');
                    this.drawPlaceholder("æ— æ•°æ®");
                    return;
                }

                const hasValidData = data.every(pt => pt && typeof pt.value === 'number');
                if (!hasValidData) {
                    console.error('âŒ CapturedWaveform: Invalid data structure');
                    this.drawPlaceholder("æ•°æ®æ ¼å¼é”™è¯¯");
                    return;
                }

                console.log(`âœ¨ CapturedWaveform: Drawing ${data.length} data points`);

                // æ¸…ç©ºèƒŒæ™¯
                this.ctx.fillStyle = '#0a0a0a';
                this.ctx.fillRect(0, 0, this.width, this.height);

                // Yè½´æ˜ å°„å‡½æ•°
                const midY = this.height / 2;
                const scaleY = (this.height / 255) * this.config.zoom;
                const mapY = (val) => midY - (val - 128) * scaleY;

                // ç»˜åˆ¶ç½‘æ ¼
                if (this.config.showGrid) {
                    this.ctx.strokeStyle = '#333';
                    this.ctx.lineWidth = 1;
                    this.ctx.beginPath();

                    for (let v = 0; v <= 255; v += 50) {
                        const y = mapY(v);
                        this.ctx.moveTo(0, y);
                        this.ctx.lineTo(this.width, y);
                    }

                    const step = this.width / 10;
                    for (let x = 0; x < this.width; x += step) {
                        this.ctx.moveTo(x, 0);
                        this.ctx.lineTo(x, this.height);
                    }
                    this.ctx.stroke();
                }

                const stepX = this.width / (data.length - 1);

                // ç»˜åˆ¶åŸºçº¿
                const baselineY = mapY(120);
                this.ctx.strokeStyle = '#dcdcaa';
                this.ctx.setLineDash([5, 5]);
                this.ctx.beginPath();
                this.ctx.moveTo(0, baselineY);
                this.ctx.lineTo(this.width, baselineY);
                this.ctx.stroke();
                this.ctx.setLineDash([]);

                // ç»˜åˆ¶æ³¢å½¢
                this.ctx.strokeStyle = '#4ec9b0';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();

                data.forEach((pt, i) => {
                    const x = i * stepX;
                    const y = mapY(pt.value);
                    if (i === 0) {
                        this.ctx.moveTo(x, y);
                    } else {
                        this.ctx.lineTo(x, y);
                    }
                });
                this.ctx.stroke();

                // ç»˜åˆ¶æ•°æ®ç‚¹
                if (this.config.showPoints) {
                    this.ctx.fillStyle = '#fff';
                    data.forEach((pt, i) => {
                        const x = i * stepX;
                        const y = mapY(pt.value);
                        this.ctx.beginPath();
                        this.ctx.arc(x, y, 2, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                }

                console.log('âœ… CapturedWaveform: Drawing completed successfully');
            }

            drawPlaceholder(message) {
                this.ctx.fillStyle = '#0a0a0a';
                this.ctx.fillRect(0, 0, this.width, this.height);

                this.ctx.fillStyle = '#666';
                this.ctx.font = '12px Arial';
                this.ctx.textAlign = 'center';
                this.ctx.textBaseline = 'middle';
                this.ctx.fillText(message, this.width / 2, this.height / 2);
            }
        }

        // ä¸»å›¾è¡¨ç»˜åˆ¶
        function drawMainChart() {
            const canvas = document.getElementById('main-chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;

            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, width, height);

            if (testState.mainData.length === 0) return;

            // ç»˜åˆ¶ç½‘æ ¼
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 1;
            ctx.beginPath();
            for (let i = 0; i <= 10; i++) {
                const y = (height / 10) * i;
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
            }
            for (let i = 0; i <= 20; i++) {
                const x = (width / 20) * i;
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
            }
            ctx.stroke();

            // ç»˜åˆ¶åŸºçº¿
            const baselineY = height - (120 / 255) * height;
            ctx.strokeStyle = '#dcdcaa';
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(0, baselineY);
            ctx.lineTo(width, baselineY);
            ctx.stroke();
            ctx.setLineDash([]);

            // ç»˜åˆ¶æ³¢å½¢
            ctx.strokeStyle = '#4ec9b0';
            ctx.lineWidth = 2;
            ctx.beginPath();

            const maxPoints = 100;
            const stepX = width / (maxPoints - 1);

            testState.mainData.slice(-maxPoints).forEach((pt, i) => {
                const x = i * stepX;
                const y = height - (pt.value / 255) * height;
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();

            // æ›´æ–°çŠ¶æ€
            document.getElementById('main-status').innerHTML =
                `çŠ¶æ€: <span class="success">è¿è¡Œä¸­</span> | æ•°æ®ç‚¹: ${testState.mainData.length} | å¸§æ•°: ${testState.frameCount}`;
        }

        // æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆ
        function generateSimulationData() {
            if (!testState.isSimulating) return;

            testState.frameCount++;
            const t = testState.frameCount * 0.05;
            let value = 120 + Math.sin(t) * 10 + (Math.random() - 0.5) * 5;

            // å¶å°”ç”Ÿæˆæ³¢å³°
            if (Math.random() > 0.95) {
                value += 40;
            }

            testState.mainData.push({ t, value });

            // ä¿æŒå›ºå®šé•¿åº¦
            if (testState.mainData.length > 200) {
                testState.mainData.shift();
            }

            drawMainChart();
            testState.animationId = requestAnimationFrame(generateSimulationData);
        }

        // æˆªå–åŠŸèƒ½
        function captureWaveform() {
            console.log('ğŸ¯ captureWaveform() called');

            try {
                const windowSize = parseInt(document.getElementById('window-size').value) || 50;
                const mainData = testState.mainData;

                console.log('ğŸ“Š Capture settings:', {
                    windowSize,
                    availableData: mainData.length,
                    testStateExists: !!testState
                });

                if (mainData.length === 0) {
                    alert('âŒ æ²¡æœ‰å¯æˆªå–çš„æ•°æ®ï¼è¯·å…ˆå¼€å§‹æ•°æ®æ¨¡æ‹Ÿã€‚');
                    return;
                }

                const actualFrameCount = Math.min(windowSize, mainData.length);
                const startIndex = mainData.length - actualFrameCount;

                console.log('ğŸ“ Data range calculation:', {
                    actualFrameCount,
                    startIndex,
                    totalFrames: mainData.length
                });

                // æ·±æ‹·è´æ•°æ®
                const capturedData = mainData.slice(startIndex).map(pt => ({
                    ...pt,
                    value: pt.value,
                    t: pt.t - mainData[startIndex].t
                }));

                console.log('ğŸ“‹ Captured data sample:', capturedData.slice(0, 3));

                testState.capturedData = capturedData;

                console.log('ğŸ’¾ Updated testState:', {
                    dataLength: testState.capturedData.length,
                    actualFrameCount
                });

                updateCaptureDisplay();

                console.log(`âœ… Successfully captured ${actualFrameCount} frames from ${mainData.length} available frames`);
            } catch (error) {
                console.error('âŒ Capture waveform error:', error);
                alert('æ³¢å½¢æˆªå–å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°æˆªå–æ˜¾ç¤º
        function updateCaptureDisplay() {
            console.log('ğŸ”„ updateCaptureDisplay() called, capture state:', {
                dataLength: testState.capturedData ? testState.capturedData.length : 0,
                rendererExists: !!window.capturedRenderer
            });

            if (testState.capturedData && testState.capturedData.length > 0) {
                if (!window.capturedRenderer) {
                    console.error('âŒ updateCaptureDisplay: capturedRenderer not initialized');
                    return;
                }

                const timestamp = new Date().toLocaleTimeString();
                document.getElementById('capture-info').innerHTML =
                    `âœ… æˆªå–æˆåŠŸ: ${testState.capturedData.length} å¸§ @ ${timestamp}`;

                const capturedSection = document.getElementById('captured-section');
                capturedSection.style.display = 'block';

                // ç­‰å¾…DOMæ›´æ–°
                setTimeout(() => {
                    try {
                        console.log('ğŸ¨ About to resize and render captured waveform');

                        if (!window.capturedRenderer) {
                            window.capturedRenderer = new CapturedWaveform('captured-chart');
                        }

                        window.capturedRenderer.resize();
                        window.capturedRenderer.draw(testState.capturedData);

                        console.log('âœ… updateCaptureDisplay: Waveform rendered successfully');

                        document.getElementById('capture-status').innerHTML =
                            `<span class="success">âœ… æˆªå–æˆåŠŸ: ${testState.capturedData.length} å¸§</span>`;
                    } catch (error) {
                        console.error('âŒ updateCaptureDisplay: Error rendering waveform:', error);
                        document.getElementById('capture-status').innerHTML =
                            `<span class="error">âŒ æ¸²æŸ“é”™è¯¯: ${error.message}</span>`;
                    }
                }, 100);
            } else {
                document.getElementById('captured-section').style.display = 'none';
                document.getElementById('capture-status').innerHTML = 'ç­‰å¾…æˆªå–...';
                console.log('updateCaptureDisplay: Hide captured display (no data)');
            }
        }

        // æ¸…é™¤æˆªå–
        function clearCapture() {
            console.log('ğŸ—‘ï¸ clearCapture() called');

            testState.capturedData = null;
            document.getElementById('captured-section').style.display = 'none';
            document.getElementById('capture-status').innerHTML = 'æˆªå–å·²æ¸…é™¤';

            if (window.capturedRenderer) {
                window.capturedRenderer.draw(null);
            }

            console.log('âœ… Capture cleared');
        }

        // æ§åˆ¶å‡½æ•°
        function startSimulation() {
            if (testState.isSimulating) return;
            testState.isSimulating = true;
            generateSimulationData();
            document.getElementById('main-status').innerHTML =
                `çŠ¶æ€: <span class="success">æ¨¡æ‹Ÿä¸­</span> | æ•°æ®ç‚¹: 0 | å¸§æ•°: 0`;
        }

        function stopSimulation() {
            testState.isSimulating = false;
            if (testState.animationId) {
                cancelAnimationFrame(testState.animationId);
            }
            document.getElementById('main-status').innerHTML =
                `çŠ¶æ€: <span class="warning">å·²åœæ­¢</span> | æ•°æ®ç‚¹: ${testState.mainData.length} | å¸§æ•°: ${testState.frameCount}`;
        }

        function clearAllData() {
            testState.mainData = [];
            testState.frameCount = 0;
            drawMainChart();
            clearCapture();
            document.getElementById('main-status').innerHTML =
                'çŠ¶æ€: å¾…æœº | æ•°æ®ç‚¹: 0 | å¸§æ•°: 0';
        }

        // äº‹ä»¶ç»‘å®š
        document.getElementById('start-simulation').addEventListener('click', startSimulation);
        document.getElementById('stop-simulation').addEventListener('click', stopSimulation);
        document.getElementById('clear-data').addEventListener('click', clearAllData);
        document.getElementById('capture-btn').addEventListener('click', captureWaveform);
        document.getElementById('clear-capture-btn').addEventListener('click', clearCapture);

        // åˆå§‹åŒ–
        drawMainChart();
        console.log('ğŸš€ æ³¢å½¢æˆªå–åŠŸèƒ½å®Œæ•´æµ‹è¯•é¡µé¢å·²åˆå§‹åŒ–');
        console.log('ğŸ“ å·²ä¿®å¤çš„é—®é¢˜åŒ…æ‹¬:');
        console.log('   - Canvas resize è‡ªåŠ¨é‡ç»˜');
        console.log('   - Canvas ä¸Šä¸‹æ–‡éªŒè¯');
        console.log('   - æ•°æ®ç»“æ„éªŒè¯');
        console.log('   - DOM æ›´æ–°æ—¶åº');
        console.log('   - è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—');

        // è‡ªåŠ¨å¼€å§‹æ¨¡æ‹Ÿæ•°æ®
        setTimeout(() => {
            startSimulation();
        }, 1000);
    </script>
</body>
</html>