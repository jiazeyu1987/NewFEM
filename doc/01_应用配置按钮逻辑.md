# 【应用配置】按钮逻辑文档

## 概述
【应用配置】按钮用于设置ROI（感兴趣区域）配置，包括坐标范围和帧率设置。

## 前端逻辑

### UI元素
- **按钮位置**: `fronted/index.html` 第528行
- **按钮ID**: `apply-roi-btn`
- **绑定事件**: `applyRoiConfig` 函数

### 前端处理流程

#### 1. 用户输入获取
```javascript
const x1 = parseInt(document.getElementById('roi-x1').value) || 0;
const y1 = parseInt(document.getElementById('roi-y1').value) || 0;
const x2 = parseInt(document.getElementById('roi-x2').value) || 0;
const y2 = parseInt(document.getElementById('roi-y2').value) || 0;
const frameRate = parseInt(document.getElementById('roi-frame-rate').value) || 2;
```

#### 2. 输入验证
- **坐标验证**:
  - `x1 < x2` 且 `y1 < y2`
  - 最小ROI尺寸: 10x10像素
- **帧率验证**:
  - 范围: 1-60 FPS
- **验证失败处理**: 显示alert弹窗并终止执行

#### 3. API调用
同时调用两个API端点:
```javascript
const [roiResponse, frameRateResponse] = await Promise.all([
    ApiService.setRoiConfig(x1, y1, x2, y2),
    ApiService.setRoiFrameRate(frameRate)
]);
```

#### 4. 响应处理
- **ROI配置成功**: 更新本地状态
  ```javascript
  appState.roiConfig = roiResponse.config;
  appState.roiConfigured = true;
  ```
- **帧率设置成功**: 更新应用状态和显示
  ```javascript
  appState.roiFrameRate = frameRate;
  appState.roiUpdateInterval = Math.floor(1000 / frameRate);
  updateRoiFrameRateDisplay();
  ```

#### 5. 日志记录
```javascript
console.log('ROI配置应用成功:', roiResponse.config);
console.log('ROI配置已保存到服务器JSON文件');
```

## 后端逻辑

### API端点1: ROI配置设置
- **路径**: `POST /roi/config`
- **文件位置**: `backends/app/api/routes.py` 第514行
- **处理器**: `set_roi_config()`

#### 后端处理流程:
1. **密码验证**: `verify_password(password)`
2. **ROI配置对象创建**:
   ```python
   roi_config = RoiConfig(x1=x1, y1=y1, x2=x2, y2=y2)
   ```
3. **坐标验证**: `roi_config.validate_coordinates()`
4. **JSON文件保存**:
   ```python
   from ..core.config_manager import get_config_manager
   config_manager = get_config_manager()

   roi_updates = {
       "x1": x1, "y1": y1, "x2": x2, "y2": y2
   }
   success = config_manager.update_config(roi_updates, section="roi_capture", key="default_config")
   ```
5. **向后兼容**: 同时保存到data_store
6. **响应返回**: `RoiConfigResponse`

### API端点2: ROI帧率设置
- **路径**: `POST /roi/frame-rate`
- **处理器**: ROI帧率验证和设置

#### JSON配置存储
配置保存到 `backends/app/fem_config.json` 文件:
```json
{
  "roi_capture": {
    "frame_rate": 2,
    "update_interval": 0.5,
    "default_config": {
      "x1": 0, "y1": 0, "x2": 200, "y2": 150
    }
  }
}
```

## 配置管理器集成

### 配置文件位置
- **文件**: `backends/app/fem_config.json`
- **管理器**: `backends/app/core/config_manager.py`

### 配置读取
ROI捕获服务启动时从JSON读取配置:
```python
# backends/app/core/roi_capture.py
from ..config import settings
self._frame_rate = settings.roi_frame_rate  # 从JSON加载
self._cache_interval = settings.roi_update_interval  # 从JSON加载
```

## 数据流程

```
用户输入 → 前端验证 → API调用 → 后端验证 → JSON文件保存 → 服务配置更新
     ↓              ↓           ↓           ↓           ↓           ↓
   表单值      → alert错误  → 并发请求  → 错误响应  → 配置文件  → ROI服务
```

## 错误处理

### 前端错误
- 输入验证失败: alert弹窗提示
- API调用失败: 显示具体错误信息
- 网络异常: console.error记录

### 后端错误
- 无效ROI坐标: HTTP 400, "INVALID_ROI_COORDINATES"
- JSON保存失败: HTTP 500, "Failed to save ROI configuration"
- 密码验证失败: HTTP 401, "密码错误"

## 日志记录

### 前端日志
- ROI配置应用成功信息
- API调用结果
- 错误详细信息

### 后端日志
- ROI配置设置请求: `🎯 Setting ROI config: (%d,%d) -> (%d,%d)`
- JSON文件保存: `✅ ROI config saved to JSON file successfully`
- 配置验证失败警告
- 错误详细信息

## 配置持久化

### 保存位置
- **JSON文件**: `backends/app/fem_config.json`
- **数据结构**: 嵌套在 `roi_capture.default_config` 节点下

### 配置重载
- ROI捕获服务支持 `reload_config()` 方法
- 服务器重启时自动从JSON文件加载配置
- 配置变更实时生效，无需重启服务

## 向后兼容性

- 保持原有API接口不变
- 同时支持data_store和JSON文件存储
- 前端逻辑无需重大修改
- 现有部署方式继续有效

## 测试验证

### 功能测试
1. 输入有效ROI坐标和帧率 → 验证JSON文件更新
2. 输入无效坐标 → 验证前端验证和错误提示
3. 输入无效帧率 → 验证前端验证和错误提示
4. 检查服务器日志 → 验证配置保存过程

### 集成测试
1. 设置ROI配置 → 重启服务器 → 验证配置持久化
2. 设置配置后 → 检查ROI捕获服务 → 验证配置生效
3. 检查JSON文件内容 → 验证数据格式正确性

## 总结
【应用配置】按钮实现了完整的ROI配置管理，包括输入验证、API调用、JSON文件保存和服务配置更新，提供了可靠的配置持久化机制。