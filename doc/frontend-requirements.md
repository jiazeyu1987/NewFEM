# NewFEM 前端技术需求规范

## 1. 概述

NewFEM 前端是一个基于纯 JavaScript 的 Web 应用程序，提供 HEM (高回声事件) 检测的实时可视化和用户交互界面。采用 VS Code 风格的设计语言，支持实时数据展示、多维度分析和用户控制。

## 2. 技术栈

- **前端框架**: 原生 JavaScript (无框架依赖)
- **样式系统**: CSS3 + VS Code 主题风格
- **通信方式**: HTTP RESTful API (fetch() API)
- **实时更新**: HTTP 轮询机制 (20 FPS)
- **可视化**: Canvas 2D API 图表渲染
- **兼容性**: 现代浏览器 (Chrome 80+, Firefox 75+, Safari 13+, Edge 80+)

## 3. 核心组件需求

### 3.1 系统状态面板

#### 3.1.1 组件描述
位置：左侧边栏顶部面板
功能：显示系统运行状态和实时数据指标

#### 3.1.2 具体需求

**连接状态指示器**
- 元素：`#connection-status`
- 状态：`connected` / `disconnected` / `connecting`
- 样式：颜色编码指示器
- 更新：实时响应连接状态变化

**数据指标显示**
- 帧数计数器 (`#frame-count`)：显示总帧数
- 当前值显示 (`#current-value`)：显示最新 ROI 灰度值
- 波峰信号 (`#peak-signal`)：显示 1/0/null 信号状态
- 基线值 (`#baseline-value`)：显示当前基线值
- 更新率 (`#update-rate`)：显示数据更新频率 (Hz)
- 缓冲区大小 (`#buffer-size`)：显示当前缓冲区帧数
- 最后更新时间 (`#last-update`)：显示最近更新时间戳

#### 3.1.3 交互需求
- 自动刷新：每 5 秒更新系统状态
- 实时更新：数据值实时响应变化
- 视觉反馈：状态变化时的颜色和文本变化
- 错误处理：连接失败时的错误显示和自动重连

### 3.2 显示控制面板

#### 3.2.1 组件描述
位置：左侧边栏中间面板
功能：控制图表显示和可视化选项

#### 3.2.2 具体需求

**显示选项控件**
- 网格显示 (`#show-grid`)：开关控制图表网格线
- 基线显示 (`#show-baseline`)：开关控制基线显示
- 数据点显示 (`#show-points`)：开关控制数据点标记
- Y轴缩放 (`#zoom-slider`)：范围滑块 (0.5x - 3.0x)
- 缩放值显示 (`#zoom-value`)：实时显示当前缩放倍数

#### 3.2.3 交互需求
- 立即响应：控件变化立即反映到图表
- 平滑过渡：缩放操作的平滑动画效果
- 鼠标支持：鼠标滚轮在图表区域支持缩放
- 状态保持：设置在会话期间保持不变

### 3.3 ROI 图像显示

#### 3.3.1 组件描述
位置：左侧边栏底部面板
功能：显示感兴趣区域的图像数据

#### 3.3.2 具体需求

**ROI 可视化画布**
- 元素：`#roi-canvas`
- 尺寸：200x150 像素固定尺寸
- 格式支持：文本格式和 base64 图像格式
- 灰度值显示 (`#roi-gray-value`)：显示 ROI 平均灰度值

#### 3.3.3 交互需求
- 实时更新：与图表数据同步更新
- 格式检测：自动识别文本或图像格式
- 错误处理：无效或缺失数据的错误显示
- 响应式：在容器内的自适应显示

### 3.4 检测控制面板

#### 3.4.1 组件描述
位置：左侧边栏底部面板
功能：提供系统控制和检测操作

#### 3.4.2 具体需求

**控制按钮组**
- 检测状态指示器 (`#detection-state`)：显示当前检测状态
- 开始检测 (`#start-btn`)：启动实时检测
- 停止检测 (`#stop-btn`)：停止检测
- 暂停检测 (`#pause-btn`)：暂停检测
- 恢复检测 (`#resume-btn`)：恢复检测
- 刷新状态 (`#refresh-status-btn`)：手动刷新系统状态

#### 3.4.3 交互需求
- 状态管理：按钮根据系统状态启用/禁用
- 即时反馈：操作后立即更新状态显示
- 确认机制：关键操作的用户确认
- 错误处理：操作失败的错误提示

### 3.5 实时波形图

#### 3.5.1 组件描述
位置：右侧主要内容区域
功能：显示实时数据波形和事件标记

#### 3.5.2 具体需求

**图表画布**
- 元素：`#waveform-chart`
- 渲染：Canvas 2D API 实时绘制
- 数据点：最多显示 100 个数据点
- 更新频率：20 FPS (50ms 间隔)

**图表状态显示**
- 元素：`#chart-status`
- 功能：显示当前图表状态和错误信息
- 位置：图表底部

#### 3.5.3 交互需求
- 实时渲染：20 FPS 流畅的数据更新
- 缩放功能：Y 轴缩放 (0.5x - 3.0x)
- 滚轮支持：鼠标滚轮在图表区域缩放
- 交互性：鼠标悬停显示数据值
- 性能优化：硬件加速渲染

## 4. JavaScript 架构需求

### 4.1 全局状态管理

```javascript
const appState = {
    connected: false,           // 连接状态
    serverUrl: 'http://localhost:8421',  // 服务器地址
    chartData: [],              // 图表数据数组
    roiData: null,              // ROI 数据对象
    frameCount: 0,              // 帧数计数
    currentValue: 0,            // 当前值
    peakSignal: null,           // 波峰信号
    baseline: 0,                // 基线值
    updateRate: 0,              // 更新率
    lastUpdateTime: null,       // 最后更新时间
    detectionState: 'IDLE',     // 检测状态
    chartState: {               // 图表状态
        showGrid: true,          // 显示网格
        showBaseline: true,      // 显示基线
        showPoints: true,        // 显示数据点
        zoom: 1.0               // 缩放倍数
    }
};
```

### 4.2 核心模块架构

#### 4.2.1 连接管理器
- **功能**: 处理服务器连接、自动重连
- **方法**: `connectToServer()`, `disconnectServer()`
- **重连策略**: 5 秒间隔自动重连
- **错误处理**: 连接失败的重试和错误提示

#### 4.2.2 数据轮询器
- **功能**: 管理实时数据的 HTTP 轮询
- **间隔**: 50ms (20 FPS)
- **数据同步**: 与服务器时间戳同步
- **性能优化**: 智能轮询频率调整

#### 4.2.3 状态更新器
- **功能**: 更新系统状态信息
- **间隔**: 5000ms (0.2 FPS)
- **状态类型**: 连接状态、运行状态、性能指标
- **实时反馈**: 状态变化的即时显示

#### 4.2.4 图表渲染器
- **功能**: Canvas 基础的实时图表渲染
- **渲染目标**: `#waveform-chart`
- **更新频率**: 20 FPS 流畅渲染
- **优化技术**: 硬件加速、增量更新

#### 4.2.5 控制处理器
- **功能**: 处理用户控制命令和 API 调用
- **命令类型**: 开始/停止/暂停/恢复检测
- **认证**: 密码保护 (31415)
- **响应处理**: 命令结果的即时反馈

#### 4.2.6 ROI 渲染器
- **功能**: ROI 图像和数据渲染
- **目标**: `#roi-canvas`
- **格式支持**: 文本和 base64 图像
- **同步机制**: 与实时数据同步更新

### 4.3 通信架构

#### 4.3.1 HTTP 轮询机制
```javascript
// 实时数据轮询 (20 FPS)
appState.realtimePollingInterval = setInterval(async () => {
    if (appState.connected) {
        await updateRealtimeData();
    }
}, 50);

// 状态更新轮询 (0.2 FPS)
appState.pollingInterval = setInterval(async () => {
    if (appState.connected) {
        await updateSystemStatus();
    }
}, 5000);
```

#### 4.3.2 自动重连机制
```javascript
// 连接失败时的自动重连
setTimeout(() => {
    if (!appState.connected) {
        connectToServer();
    }
}, 5000);
```

## 5. 数据可视化需求

### 5.1 Canvas 图表规格

#### 5.1.1 基本配置
- **Canvas ID**: `waveform-chart`
- **最小高度**: 400px
- **宽度**: 响应式，适应容器宽度
- **像素密度**: 支持 Retina 显示

#### 5.1.2 数据渲染要求
- **数据点**: 最多 100 个连续点
- **渲染帧率**: 20 FPS
- **插值方法**: 线性插值平滑曲线
- **颜色主题**: VS Code 主题色彩

#### 5.1.3 交互功能
- **Y轴缩放**: 0.5x - 3.0x 范围
- **鼠标滚轮**: 缩放操作支持
- **悬停提示**: 数据值显示
- **网格显示**: 可选的参考网格

### 5.2 ROI 可视化规格

#### 5.2.1 显示要求
- **画布尺寸**: 200x150 像素
- **更新频率**: 与主图表同步
- **格式类型**: 动态检测 (text/base64)
- **错误处理**: 无效数据的占位显示

#### 5.2.2 数据格式支持
```javascript
// 文本格式
{
    format: 'text',
    pixels: 'simulated_roi_120.5'
}

// 图像格式
{
    format: 'base64',
    pixels: 'data:image/png;base64,iVBORw0KGgo...'
}
```

## 6. 交互设计需求

### 6.1 用户交互模式

#### 6.1.1 连接交互
- **自动连接**: 页面加载后 500ms 自动尝试连接
- **连接状态**: 实时显示连接状态和进度
- **错误处理**: 连接失败的用户友好提示
- **重连机制**: 5 秒间隔的自动重连

#### 6.1.2 控制交互
- **按钮状态**: 根据系统状态启用/禁用控制按钮
- **操作反馈**: 即时的操作结果反馈
- **确认机制**: 关键操作的用户确认对话框
- **快捷操作**: 状态栏快捷操作按钮

#### 6.1.3 可视化交互
- **图表缩放**: 鼠标滚轮和滑块双重控制
- **显示选项**: 实时切换的显示选项
- **数据探索**: 鼠标悬停的数据值显示
- **状态持久化**: 选项设置的会话保持

### 6.2 错误处理需求

#### 6.2.1 连接错误
- **网络错误**: 连接超时和服务器不可达
- **API 错误**: HTTP 状态码和错误消息
- **数据错误**: 格式错误和数据缺失
- **恢复机制**: 自动重连和降级处理

#### 6.2.2 用户反馈
- **错误提示**: 清晰的错误信息显示
- **状态指示**: 连接状态的视觉反馈
- **操作反馈**: 操作成功/失败的即时通知
- **恢复指导**: 错误恢复的操作建议

## 7. 性能需求

### 7.1 渲染性能
- **帧率要求**: 稳定 20 FPS 图表更新
- **渲染延迟**: < 50ms 端到端延迟
- **内存使用**: < 100MB 浏览器内存占用
- **CPU 使用**: < 30% CPU 占用率

### 7.2 网络性能
- **API 响应**: < 100ms API 响应时间
- **轮询频率**: 20 FPS 实时数据更新
- **数据传输**: < 10KB 每次请求
- **并发连接**: 支持多标签页同时使用

### 7.3 用户体验
- **加载时间**: < 2 秒页面加载完成
- **交互响应**: < 100ms 用户交互响应
- **动画流畅**: 60 FPS 动画效果
- **兼容性**: 主流浏览器完全兼容

## 8. 兼容性需求

### 8.1 浏览器兼容性
- **Chrome**: 80+ (推荐)
- **Firefox**: 75+
- **Safari**: 13+
- **Edge**: 80+

### 8.2 功能降级
- **Canvas**: 不支持时显示表格数据
- **Fetch API**: 不支持时使用 XMLHttpRequest
- **ES6**: 关键功能的兼容性处理
- **CORS**: 开发环境支持，生产环境配置

### 8.3 设备兼容性
- **桌面端**: 主要支持目标
- **移动端**: 响应式布局适配
- **触摸设备**: 触摸操作支持
- **高DPI**: Retina 显示优化

## 9. 安全需求

### 9.1 数据安全
- **输入验证**: 所有用户输入验证
- **XSS 防护**: 输出内容安全转义
- **CSRF 防护**: 同源策略保护
- **敏感信息**: 不存储敏感数据

### 9.2 通信安全
- **HTTPS**: 生产环境强制 HTTPS
- **认证**: 密码保护的控制命令
- **授权**: 最小权限原则
- **数据传输**: 加密传输敏感数据

## 10. 维护需求

### 10.1 代码维护
- **模块化**: 清晰的模块结构
- **注释**: 完整的代码注释
- **文档**: 详细的 API 文档
- **测试**: 完整的功能测试

### 10.2 性能监控
- **性能指标**: FPS、内存、CPU 监控
- **错误跟踪**: 异常日志和错误报告
- **用户行为**: 交互行为分析
- **兼容性**: 浏览器兼容性监控

### 10.3 版本管理
- **版本控制**: Git 版本管理
- **发布流程**: 自动化构建和部署
- **版本兼容**: 向后兼容性保证
- **回滚机制**: 快速回滚到稳定版本

---

此文档定义了 NewFEM 前端的完整技术需求，为开发、测试和维护提供详细的技术规范和实现指导。