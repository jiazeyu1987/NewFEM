# ã€ç«‹å³æˆªå–ã€‘æŒ‰é’®é€»è¾‘æ–‡æ¡£

## æ¦‚è¿°
ã€ç«‹å³æˆªå–ã€‘æŒ‰é’®ç”¨äºæ‰§è¡Œçª—å£æ•°æ®æˆªå–åŠŸèƒ½ï¼Œæˆªå–æŒ‡å®šæ—¶é—´çª—å£å†…çš„å®æ—¶æ•°æ®æˆ–ROIæ•°æ®ï¼Œå¹¶è¿›è¡Œæ³¢å³°æ£€æµ‹åˆ†æï¼ŒåŒæ—¶åœ¨ç•Œé¢ä¸­æ˜¾ç¤ºæ³¢å³°é¢œè‰²æŒ‡ç¤ºå™¨ã€‚

## å‰ç«¯é€»è¾‘

### UIå…ƒç´ 
- **æŒ‰é’®ä½ç½®**: `fronted/index.html` ç¬¬437è¡Œ
- **æŒ‰é’®ID**: `capture-btn`
- **æŒ‰é’®æ–‡æœ¬**: "ğŸ“¸ ç«‹å³æˆªå–"
- **ç»‘å®šäº‹ä»¶**: WaveformCaptureç±»çš„captureWaveformæ–¹æ³•

### å‰ç«¯å¤„ç†æµç¨‹

#### 1. äº‹ä»¶ç»‘å®š
```javascript
// WaveformCaptureç±»æ„é€ å‡½æ•°ä¸­ç»‘å®šäº‹ä»¶
this.elements.captureBtn.addEventListener('click', () => {
    this.captureWaveform();
});
```

#### 2. æˆªå–æ–¹æ³•å…¥å£
```javascript
async captureWaveform() {
    // ä¸»è¦æˆªå–é€»è¾‘
}
```

#### 3. çª—å£å¤§å°è·å–
```javascript
const windowSize = parseInt(this.elements.windowSlider.value) || 100;
```

#### 4. æ•°æ®æºé€‰æ‹©
```javascript
const dataSource = this.elements.dataSourceMain.checked ? 'main' : 'roi';
```

#### 5. æ³¢å³°æ£€æµ‹å‚æ•°è·å–
```javascript
// ä»åº”ç”¨çŠ¶æ€è·å–å½“å‰é…ç½®
const currentConfig = appState.peakConfig;
response = await ApiService.captureRoiWindowWithPeaks(
    this.captureSettings.windowSize,
    currentConfig?.threshold || 105.0,           // ä½¿ç”¨é…ç½®å€¼
    currentConfig?.margin_frames || 5,            // ä½¿ç”¨é…ç½®å€¼
    currentConfig?.difference_threshold || 2.1    // ä½¿ç”¨é…ç½®å€¼
);
```

#### 6. UIçŠ¶æ€æ›´æ–°
```javascript
// æ›´æ–°æŒ‰é’®çŠ¶æ€
this.updateStatus('processing', 'æˆªå–ä¸­...');
this.elements.captureBtn.disabled = true;
this.elements.captureBtn.textContent = 'æˆªå–ä¸­...';
```

#### 7. æ•°æ®å¤„ç†å’Œæ˜¾ç¤º
```javascript
if (response && response.success) {
    // æ˜¾ç¤ºæˆªå–çš„æ³¢å½¢æ•°æ®
    this.displayCapturedData(response.data);

    // æ˜¾ç¤ºæˆåŠŸåé¦ˆ
    this.addSuccessFeedback();
} else {
    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    this.updateStatus('error', 'æˆªå–å¤±è´¥');
}
```

#### 8. æ³¢å³°é¢œè‰²æŒ‡ç¤ºå™¨æ›´æ–°
```javascript
// åœ¨displayCapturedDataæ–¹æ³•ä¸­
if (data.peak_detection_results && !data.peak_detection_results.error) {
    const results = data.peak_detection_results;
    this.updatePeakIndicator(results);
} else {
    this.updatePeakIndicator(null);
}
```

#### 9. æ³¢å³°æŒ‡ç¤ºå™¨é€»è¾‘
```javascript
updatePeakIndicator(peakResults) {
    if (!peakResults || peakResults.error || peakResults.total_peaks === 0) {
        // æ²¡æœ‰æ³¢å³°æˆ–é”™è¯¯æ—¶æ˜¾ç¤º0ï¼ˆçº¢è‰²ï¼‰
        indicatorText.textContent = '0';
        indicatorText.style.backgroundColor = '#d32f2f';
    } else {
        // è®¡ç®—è·ç¦»æˆªå–ç‚¹æœ€è¿‘çš„æ³¢å³°
        const capturePoint = Math.floor(this.captureSettings.windowSize / 2);

        // æŸ¥æ‰¾æœ€è¿‘çš„ç»¿è‰²å’Œçº¢è‰²æ³¢å³°
        let closestGreenDistance = Infinity;
        let closestRedDistance = Infinity;

        // è®¡ç®—è·ç¦»å¹¶æ¯”è¾ƒ
        if (closestGreenDistance < closestRedDistance) {
            // æœ€è¿‘çš„æ³¢å³°æ˜¯ç»¿è‰²ï¼Œæ˜¾ç¤º1ï¼ˆç»¿è‰²ï¼‰
            indicatorText.textContent = '1';
            indicatorText.style.backgroundColor = '#4caf50';
        } else {
            // æœ€è¿‘çš„æ³¢å³°æ˜¯çº¢è‰²æˆ–æ²¡æœ‰æ³¢å³°ï¼Œæ˜¾ç¤º0ï¼ˆçº¢è‰²ï¼‰
            indicatorText.textContent = '0';
            indicatorText.style.backgroundColor = '#d32f2f';
        }
    }
}
```

#### 10. æˆåŠŸåé¦ˆåŠ¨ç”»
```javascript
addSuccessFeedback() {
    // æŒ‰é’®æˆåŠŸåŠ¨ç”»
    this.elements.captureBtn.classList.add('success');
    this.elements.captureBtn.textContent = 'âœ… æˆªå–æˆåŠŸ';

    // æ¢å¤æŒ‰é’®çŠ¶æ€
    setTimeout(() => {
        this.elements.captureBtn.classList.remove('success');
    }, 1000);

    // éœ‡åŠ¨åé¦ˆï¼ˆå¦‚æœæ”¯æŒï¼‰
    if ('vibrate' in navigator) {
        navigator.vibrate(50);
    }
}
```

## åç«¯é€»è¾‘

### APIç«¯ç‚¹
- **è·¯å¾„**: `GET /data/roi-window-capture-with-peaks`
- **æ–‡ä»¶ä½ç½®**: `backends/app/api/routes.py` ç¬¬986è¡Œ
- **å¤„ç†å™¨**: `roi_window_capture_with_peaks()` å‡½æ•°
- **HTTPæ–¹æ³•**: GET (ä½¿ç”¨Queryå‚æ•°)

### åç«¯å¤„ç†æµç¨‹

#### 1. å‚æ•°è§£æ
```python
@router.get("/data/roi-window-capture-with-peaks", response_model=RoiWindowCaptureWithPeaksResponse)
async def roi_window_capture_with_peaks(
    count: int = Query(50, ge=50, le=500, description="æˆªå–çª—å£å¤§å°ï¼ˆæ•°æ®ç‚¹æ•°ï¼‰"),
    threshold: Optional[float] = Query(None, description="æ³¢å³°æ£€æµ‹é˜ˆå€¼"),
    margin_frames: Optional[int] = Query(None, description="è¾¹ç•Œæ‰©å±•å¸§æ•°"),
    difference_threshold: Optional[float] = Query(None, description="é¢œè‰²åˆ†ç±»é˜ˆå€¼")
):
```

#### 2. å‚æ•°éªŒè¯
```python
# å‚æ•°èŒƒå›´é€šè¿‡Queryå‚æ•°çš„ge=50, le=500è‡ªåŠ¨éªŒè¯
# countå‚æ•°èŒƒå›´: 50 <= count <= 500
```

#### 3. é»˜è®¤å‚æ•°è®¾ç½®
```python
# å¦‚æœå‰ç«¯æ²¡æœ‰ä¼ é€’å‚æ•°ï¼Œä½¿ç”¨JSONé…ç½®æ–‡ä»¶ä¸­çš„å€¼
if threshold is None:
    threshold = settings.peak_threshold
if margin_frames is None:
    margin_frames = settings.peak_margin_frames
if difference_threshold is None:
    difference_threshold = settings.peak_difference_threshold
```

#### 4. æ•°æ®è·å–
```python
# ä»data_storeè·å–æŒ‡å®šçª—å£çš„æ•°æ®
window_data = data_store.get_window_data(count)
if not window_data:
    raise HTTPException(status_code=404, detail="æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®è¿›è¡Œçª—å£æˆªå–")
```

#### 5. æ³¢å³°æ£€æµ‹æ‰§è¡Œ
```python
# æå–ç°åº¦å€¼åºåˆ—
curve_data = [point.value for point in window_data]

# æ‰§è¡Œæ³¢å³°æ£€æµ‹
green_peaks, red_peaks = detect_peaks(
    curve=curve_data,
    threshold=threshold,
    marginFrames=margin_frames,
    differenceThreshold=difference_threshold
)
```

#### 6. æ£€æµ‹ç»“æœç»Ÿè®¡
```python
# ç»Ÿè®¡æ£€æµ‹ç»“æœ
total_peaks = len(green_peaks) + len(red_peaks)
green_peak_count = len(green_peaks)
red_peak_count = len(red_peaks)
```

#### 7. å¸¦æ³¢å³°æ ‡æ³¨çš„å›¾åƒç”Ÿæˆ
```python
# ç”Ÿæˆå¸¦æœ‰æ³¢å³°æ ‡æ³¨çš„æ³¢å½¢å›¾åƒ
waveform_image = generate_waveform_image_with_peaks(
    curve_data=curve_data,
    green_peaks=green_peaks,
    red_peaks=red_peaks,
    width=600,
    height=300
)
```

#### 8. å“åº”æ•°æ®æ„å»º
```python
return RoiWindowCaptureWithPeaksResponse(
    success=True,
    timestamp=datetime.utcnow(),
    series=window_data,
    frame_range=frame_range,
    capture_metadata=capture_metadata,
    waveform_image=waveform_image,
    peak_detection_results={
        "total_peaks": total_peaks,
        "green_peak_count": green_peak_count,
        "red_peak_count": red_peak_count,
        "green_peaks": green_peaks,
        "red_peaks": red_peaks,
        "peak_detection_params": {
            "threshold": threshold,
            "margin_frames": margin_frames,
            "difference_threshold": difference_threshold
        }
    }
)
```

## æ•°æ®æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡» â†’ çª—å£å¤§å°è®¾ç½® â†’ APIè°ƒç”¨ â†’ æ•°æ®è·å– â†’ æ³¢å³°æ£€æµ‹ â†’ å›¾åƒç”Ÿæˆ â†’ å“åº”è¿”å›
    â†“           â†“             â†“         â†“         â†“           â†“           â†“
  ç«‹å³æˆªå–   â†’ æ»‘å—å€¼è¯»å–  â†’ å¸¦å‚è¯·æ±‚ â†’ data_store â†’ detect_peaks â†’ å›¾åƒç”Ÿæˆ  â†’ å‰ç«¯æ˜¾ç¤º
                                                                â†“
                                                           æ³¢å³°æŒ‡ç¤ºå™¨
```

## æ³¢å³°æ£€æµ‹é›†æˆ

### æ£€æµ‹ç®—æ³•è°ƒç”¨
- **å‡½æ•°**: `detect_peaks()`
- **æ–‡ä»¶ä½ç½®**: `backends/app/peak_detection.py`
- **å‚æ•°æ¥æº**: JSONé…ç½®æ–‡ä»¶ + APIå‚æ•°

### æ£€æµ‹ç»“æœç»“æ„
```python
# æ³¢å³°æ£€æµ‹ç»“æœ
peak_detection_results = {
    "total_peaks": 5,           # æ€»æ³¢å³°æ•°é‡
    "green_peak_count": 3,      # ç»¿è‰²æ³¢å³°æ•°é‡
    "red_peak_count": 2,        # çº¢è‰²æ³¢å³°æ•°é‡
    "green_peaks": [[10,15], [25,30], [45,50]],    # ç»¿è‰²æ³¢å³°èŒƒå›´
    "red_peaks": [[60,65], [75,80]],               # çº¢è‰²æ³¢å³°èŒƒå›´
    "peak_detection_params": {                      # ä½¿ç”¨çš„æ£€æµ‹å‚æ•°
        "threshold": 105.0,
        "margin_frames": 5,
        "difference_threshold": 2.1
    }
}
```

### æ³¢å³°é¢œè‰²æŒ‡ç¤ºå™¨é€»è¾‘

#### è·ç¦»è®¡ç®—
- **æˆªå–ç‚¹**: çª—å£ä¸­å¿ƒä½ç½® (`windowSize / 2`)
- **æ³¢å³°ä¸­å¿ƒ**: `(start + end) / 2`
- **è·ç¦»è®¡ç®—**: `abs(peak_center - capture_point)`

#### æŒ‡ç¤ºå™¨æ˜¾ç¤ºè§„åˆ™
- **ç»¿è‰²æ³¢å³°æœ€è¿‘**: æ˜¾ç¤º "1"ï¼ˆç»¿è‰²èƒŒæ™¯ï¼‰
- **çº¢è‰²æ³¢å³°æœ€è¿‘æˆ–æ— æ³¢å³°**: æ˜¾ç¤º "0"ï¼ˆçº¢è‰²èƒŒæ™¯ï¼‰

## å›¾åƒç”ŸæˆåŠŸèƒ½

### æ³¢å½¢å›¾åƒç”Ÿæˆ
- **å‡½æ•°**: `generate_waveform_image_with_peaks()`
- **æ–‡ä»¶ä½ç½®**: `backends/app/utils/roi_image_generator.py`
- **å›¾åƒå°ºå¯¸**: 600x300åƒç´ 
- **æ ¼å¼**: PNG base64ç¼–ç 

### å›¾åƒç‰¹æ€§
- **æ³¢å½¢æ›²çº¿**: è“è‰²çº¿æ¡ç»˜åˆ¶
- **ç»¿è‰²æ³¢å³°**: ç»¿è‰²é«˜äº®æ˜¾ç¤º
- **çº¢è‰²æ³¢å³°**: çº¢è‰²é«˜äº®æ˜¾ç¤º
- **åæ ‡è½´**: å¸¦åˆ»åº¦æ ‡æ³¨
- **èƒŒæ™¯**: ç™½è‰²èƒŒæ™¯

## å­æ³¢å½¢å›¾è¡¨æ˜¾ç¤º

### SubWaveformChartç±»
- **æ–‡ä»¶ä½ç½®**: `fronted/index.html`
- **åŠŸèƒ½**: æ˜¾ç¤ºæˆªå–çš„å­æ³¢å½¢æ•°æ®
- **äº¤äº’**: æ”¯æŒé¼ æ ‡æ‚¬åœæ˜¾ç¤ºæ•°å€¼

### æ•°æ®ç»‘å®š
```javascript
this.subWaveformChart.setData(series);  // ç»‘å®šæˆªå–çš„æ•°æ®
```

### é¼ æ ‡äº¤äº’åŠŸèƒ½
- **é¼ æ ‡æ‚¬åœ**: åœ¨åº•éƒ¨çŠ¶æ€æ æ˜¾ç¤ºè¯¦ç»†æ•°å€¼
- **æ•°å€¼æ˜¾ç¤º**: ç´¢å¼•ã€æ—¶é—´ã€æ•°å€¼ã€åŸºçº¿ã€å·®å¼‚ã€ä½ç½®
- **çŠ¶æ€æ æ›´æ–°**: `updateStatusBar()` æ–¹æ³•

## é”™è¯¯å¤„ç†

### å‰ç«¯é”™è¯¯
- **çª—å£å¤§å°æ— æ•ˆ**: æ»‘å—æœ‰æœ€å°å€¼é™åˆ¶
- **APIè°ƒç”¨å¤±è´¥**: æ˜¾ç¤ºé”™è¯¯çŠ¶æ€å’Œæ¶ˆæ¯
- **æ•°æ®æ ¼å¼é”™è¯¯**: console.errorè®°å½•
- **ç½‘ç»œå¼‚å¸¸**: æ˜¾ç¤ºè¿æ¥é”™è¯¯çŠ¶æ€

### åç«¯é”™è¯¯
- **çª—å£å¤§å°è¶…é™**: HTTP 400, "çª—å£å¤§å°å¿…é¡»åœ¨10-1000ä¹‹é—´"
- **æ•°æ®ä¸è¶³**: HTTP 404, "æ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®è¿›è¡Œçª—å£æˆªå–"
- **å›¾åƒç”Ÿæˆå¤±è´¥**: HTTP 500, è¯¦ç»†é”™è¯¯ä¿¡æ¯

## é…ç½®é›†æˆ

### å‚æ•°è·å–ä¼˜å…ˆçº§
1. **APIä¼ é€’å‚æ•°**: æœ€é«˜ä¼˜å…ˆçº§
2. **JSONé…ç½®æ–‡ä»¶**: æ¬¡ä¼˜å…ˆçº§
3. **é»˜è®¤å€¼**: æœ€ä½ä¼˜å…ˆçº§

### JSONé…ç½®è¯»å–
```python
# ä»JSONé…ç½®æ–‡ä»¶è¯»å–é»˜è®¤å‚æ•°
if threshold is None:
    threshold = settings.peak_threshold  # ä»fem_config.jsonè¯»å–
```

## çŠ¶æ€ç®¡ç†

### æŒ‰é’®çŠ¶æ€
```javascript
// æˆªå–ä¸­çŠ¶æ€
this.elements.captureBtn.disabled = true;
this.elements.captureBtn.textContent = 'æˆªå–ä¸­...';

// æˆåŠŸçŠ¶æ€
this.elements.captureBtn.classList.add('success');
this.elements.captureBtn.textContent = 'âœ… æˆªå–æˆåŠŸ';

// æ­£å¸¸çŠ¶æ€
this.elements.captureBtn.disabled = false;
this.elements.captureBtn.textContent = 'ğŸ“¸ ç«‹å³æˆªå–';
```

### çŠ¶æ€æŒ‡ç¤ºå™¨
```javascript
// çŠ¶æ€æ–‡æœ¬æ›´æ–°
this.updateStatus('processing', 'æˆªå–ä¸­...');
this.updateStatus('disconnected', 'ç­‰å¾…æˆªå–');
```

## æ€§èƒ½è€ƒè™‘

### æ•°æ®è·å–æ€§èƒ½
- **çª—å£å¤§å°**: é™åˆ¶åœ¨10-1000ä¸ªæ•°æ®ç‚¹
- **å†…å­˜ä½¿ç”¨**: çº¿æ€§æ—¶é—´å¤æ‚åº¦O(n)
- **å“åº”æ—¶é—´**: é€šå¸¸åœ¨100mså†…å®Œæˆ

### å›¾åƒç”Ÿæˆæ€§èƒ½
- **å›¾åƒå°ºå¯¸**: å›ºå®š600x300åƒç´ 
- **ç”Ÿæˆç®—æ³•**: ä¼˜åŒ–çš„PILç»˜åˆ¶
- **ç¼–ç æ—¶é—´**: PNGç¼–ç é€šå¸¸<50ms

### å‰ç«¯æ¸²æŸ“æ€§èƒ½
- **Canvasæ¸²æŸ“**: ç¡¬ä»¶åŠ é€Ÿ
- **åŠ¨ç”»æ•ˆæœ**: CSS transitions
- **å†…å­˜ç®¡ç†**: åŠæ—¶é‡Šæ”¾å¤§å›¾åƒæ•°æ®

## ç”¨æˆ·ä½“éªŒä¼˜åŒ–

### è§†è§‰åé¦ˆ
- **æŒ‰é’®çŠ¶æ€**: å³æ—¶è§†è§‰åé¦ˆ
- **åŠ è½½åŠ¨ç”»**: æˆªå–ä¸­æ˜¾ç¤ºåŠ¨ç”»
- **æˆåŠŸæç¤º**: ç»¿è‰²æˆåŠŸçŠ¶æ€
- **éœ‡åŠ¨åé¦ˆ**: ç§»åŠ¨è®¾å¤‡éœ‡åŠ¨æç¤º

### äº¤äº’ä¼˜åŒ–
- **é˜²é‡å¤ç‚¹å‡»**: æˆªå–ä¸­ç¦ç”¨æŒ‰é’®
- **é”™è¯¯æç¤º**: æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
- **æ•°å€¼æ˜¾ç¤º**: é¼ æ ‡æ‚¬åœæ˜¾ç¤ºè¯¦ç»†æ•°æ®
- **çŠ¶æ€æŒ‡ç¤º**: å®æ—¶çŠ¶æ€æ›´æ–°

## æµ‹è¯•éªŒè¯

### åŠŸèƒ½æµ‹è¯•
1. **æ­£å¸¸æˆªå–æµ‹è¯•**: éªŒè¯å®Œæ•´æˆªå–æµç¨‹
2. **å‚æ•°é…ç½®æµ‹è¯•**: éªŒè¯ä¸åŒå‚æ•°çš„å½±å“
3. **é”™è¯¯å¤„ç†æµ‹è¯•**: éªŒè¯å„ç§å¼‚å¸¸æƒ…å†µ
4. **UIçŠ¶æ€æµ‹è¯•**: éªŒè¯æŒ‰é’®çŠ¶æ€å˜åŒ–

### æ€§èƒ½æµ‹è¯•
1. **å¤§æ•°æ®é‡æµ‹è¯•**: æµ‹è¯•æœ€å¤§çª—å£å¤§å°
2. **å“åº”æ—¶é—´æµ‹è¯•**: æµ‹è¯•APIå“åº”æ—¶é—´
3. **å†…å­˜ä½¿ç”¨æµ‹è¯•**: æµ‹è¯•é•¿æ—¶é—´ä½¿ç”¨
4. **å¹¶å‘æµ‹è¯•**: æµ‹è¯•å¤šä¸ªæˆªå–è¯·æ±‚

## æ€»ç»“
ã€ç«‹å³æˆªå–ã€‘æŒ‰é’®å®ç°äº†å®Œæ•´çš„æ•°æ®çª—å£æˆªå–åŠŸèƒ½ï¼ŒåŒ…æ‹¬å‚æ•°é…ç½®ã€æ•°æ®è·å–ã€æ³¢å³°æ£€æµ‹ã€å›¾åƒç”Ÿæˆå’Œç”¨æˆ·äº¤äº’åé¦ˆï¼Œæä¾›äº†ç›´è§‚çš„HEMäº‹ä»¶æ£€æµ‹å’Œåˆ†æèƒ½åŠ›ã€‚æ³¢å³°é¢œè‰²æŒ‡ç¤ºå™¨ä¸ºç”¨æˆ·æä¾›äº†å¿«é€Ÿè¯†åˆ«æœ€è¿‘æ³¢å³°ç±»å‹çš„èƒ½åŠ›ã€‚